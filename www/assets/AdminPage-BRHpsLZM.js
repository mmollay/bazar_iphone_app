import{e as oe,n as Be,r as o,f as v,j as e,B as d,T as i,P as $,ad as ee,ag as me,ah as se,L as h,A as M,Q as Ee,t as H,aB as De,l as I,x as Re,H as we,K as D,w as We,as as Ie,M as Me,av as Se,a3 as $e,C as He,V as Pe,D as te,p as ne,q as re,v as ie,ax as ae,ay as le,a_ as ke,a$ as L,ac as Oe,ap as Ne,b0 as Ue,N as ve,o as Ke,O as _e,aY as qe,R as Ge,b1 as Ve,aZ as Ze}from"./index-BuAgU3zd.js";import{S as Qe}from"./save-D0F9-qu4.js";import{S as ge}from"./Snackbar-DhT3mds5.js";import{a as Ce,b as Te,c as ze,d as N,e as a,f as Ae,T as Ye}from"./TableRow-CIMhwIee.js";import{C as Le}from"./credit-card-BaRyumPo.js";import{G}from"./Grid-D-_RPv1w.js";import{P as Je}from"./plus-C9AcDJYN.js";import{A as Xe,a as es,b as ss}from"./AccordionSummary-Bu-Ell5d.js";import{C as ts}from"./calendar-FLaLKf1X.js";import"./Collapse-CgvX06SA.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=oe("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=oe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=oe("Key",[["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["path",{d:"m15.5 7.5 3 3L22 7l-3-3",key:"1rn1fs"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=oe("ListTodo",[["rect",{x:"3",y:"5",width:"6",height:"6",rx:"1",key:"1defrl"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=oe("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]),je=()=>{const{user:p}=Be(),[_,S]=o.useState(!1),[k,C]=o.useState(!0);return o.useEffect(()=>{(async()=>{if(!p){S(!1),C(!1);return}const{data:l}=await v.from("profiles").select("is_admin").eq("id",p.id).maybeSingle();S((l==null?void 0:l.is_admin)===!0),C(!1)})()},[p]),{isAdmin:_,loading:k,getSystemSettings:async()=>{const{data:t,error:l}=await v.from("system_settings").select("*").limit(1).maybeSingle();if(l)throw l;return t},updateSystemSettings:async t=>{const{data:l}=await v.from("system_settings").select("id").limit(1).maybeSingle();if(!l)throw new Error("System settings not found");const{error:j}=await v.from("system_settings").update({...t,updated_at:new Date().toISOString(),updated_by:p==null?void 0:p.id}).eq("id",l.id);if(j)throw j},getAllUsers:async()=>{const{data:t,error:l}=await v.rpc("get_all_users_admin");if(l)throw l;return t||[]},suspendUser:async(t,l)=>{const{error:j}=await v.rpc("suspend_user_admin",{target_user_id:t,reason:l});if(j)throw j},unsuspendUser:async t=>{const{error:l}=await v.rpc("unsuspend_user_admin",{target_user_id:t});if(l)throw l},deleteUser:async t=>{const{error:l}=await v.rpc("delete_user_admin",{target_user_id:t});if(l)throw l},updateUserTokens:async(t,l)=>{const{error:j}=await v.from("user_tokens").update({balance:l}).eq("user_id",t);if(j)throw j},getAllRoles:async()=>{const{data:t,error:l}=await v.rpc("get_all_roles_with_permissions");if(l)throw l;return t||[]},getUserRoles:async t=>{const{data:l,error:j}=await v.rpc("get_user_roles",{check_user_id:t});if(j)throw j;return l||[]},assignRole:async(t,l)=>{const{error:j}=await v.rpc("assign_role_to_user",{target_user_id:t,target_role_id:l});if(j)throw j},removeRole:async(t,l)=>{const{error:j}=await v.rpc("remove_role_from_user",{target_user_id:t,target_role_id:l});if(j)throw j},getUserPermissions:async t=>{const{data:l,error:j}=await v.rpc("get_user_permissions",{check_user_id:t});if(j)throw j;return l||[]},hasPermission:async t=>{if(!p)return!1;const{data:l,error:j}=await v.rpc("user_has_permission",{check_user_id:p.id,permission_name:t});return j?!1:l||!1}}},ls=()=>{const{getSystemSettings:p,updateSystemSettings:_}=je(),[S,k]=o.useState(!1),[C,w]=o.useState(!1),[y,A]=o.useState({open:!1,message:"",severity:"success"}),[g,c]=o.useState({id:"",token_system_mode:"enabled",default_token_package:100,token_price_per_100:1.99,platform_message:null,updated_at:"",updated_by:null});o.useEffect(()=>{B()},[]);const B=async()=>{k(!0);try{const u=await p();u&&c(u)}catch(u){A({open:!0,message:`Fehler beim Laden: ${u.message}`,severity:"error"})}finally{k(!1)}},P=async()=>{w(!0);try{await _({token_system_mode:g.token_system_mode,default_token_package:g.default_token_package,token_price_per_100:g.token_price_per_100,platform_message:g.platform_message}),A({open:!0,message:"Einstellungen erfolgreich gespeichert",severity:"success"}),await B()}catch(u){A({open:!0,message:`Fehler beim Speichern: ${u.message}`,severity:"error"})}finally{w(!1)}};return S?e.jsx(d,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(i,{children:"Lade Einstellungen..."})}):e.jsxs(d,{children:[e.jsxs($,{sx:{p:3,mb:3},children:[e.jsx(i,{variant:"h6",sx:{mb:3,fontWeight:600},children:"Token-System"}),e.jsxs(ee,{fullWidth:!0,sx:{mb:3},children:[e.jsx(me,{children:"Token-System Modus"}),e.jsxs(se,{value:g.token_system_mode,label:"Token-System Modus",onChange:u=>c({...g,token_system_mode:u.target.value}),children:[e.jsx(h,{value:"enabled",children:"Aktiviert - Normale Token-Nutzung"}),e.jsx(h,{value:"donation_only",children:"Nur Spenden - Kostenloser Test-Modus"}),e.jsx(h,{value:"disabled",children:"Deaktiviert - Keine Token-Funktion"})]})]}),g.token_system_mode==="donation_only"&&e.jsx(M,{severity:"info",sx:{mb:3},children:"Im Spenden-Modus können Benutzer alle Funktionen kostenlos testen. Das ist ideal für Freunde während der Testphase."}),g.token_system_mode==="disabled"&&e.jsx(M,{severity:"warning",sx:{mb:3},children:"Im deaktivierten Modus sind alle Token-Funktionen ausgeblendet."}),e.jsx(Ee,{sx:{my:3}}),e.jsx(i,{variant:"h6",sx:{mb:1,fontWeight:600},children:"Token-Preise"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Hier kannst du die Preisstruktur für Token-Pakete festlegen. Diese Preise gelten systemweit und beeinflussen alle Kauf-Optionen."}),e.jsxs(d,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(H,{label:"Basis-Einheit",type:"number",fullWidth:!0,value:g.default_token_package,onChange:u=>c({...g,default_token_package:parseInt(u.target.value)||0}),InputProps:{endAdornment:e.jsx(De,{position:"end",children:"Tokens"})},helperText:"Die kleinste kaufbare Token-Menge (z.B. 100)",sx:{minWidth:250}}),e.jsx(H,{label:"Preis pro 100 Tokens",type:"number",fullWidth:!0,value:g.token_price_per_100,onChange:u=>c({...g,token_price_per_100:parseFloat(u.target.value)||0}),InputProps:{startAdornment:e.jsx(De,{position:"start",children:"€"})},inputProps:{step:.01,min:0},helperText:"Basispreis für 100 Tokens (z.B. 1,99 €)",sx:{minWidth:250}})]}),e.jsxs(M,{severity:"info",sx:{mb:0},children:[e.jsx(i,{variant:"body2",fontWeight:600,mb:1,children:"Berechnungsbeispiel:"}),e.jsxs(i,{variant:"body2",component:"div",children:["• 100 Tokens = ",g.token_price_per_100.toFixed(2)," €",e.jsx("br",{}),"• 200 Tokens = ",(g.token_price_per_100*2).toFixed(2)," €",e.jsx("br",{}),"• 500 Tokens = ",(g.token_price_per_100*5).toFixed(2)," €",e.jsx("br",{}),"• 1.000 Tokens = ",(g.token_price_per_100*10).toFixed(2)," €"]}),e.jsx(i,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1},children:"Die Token-Pakete auf der Kaufseite können zusätzliche Bonus-Tokens enthalten (z.B. 10% mehr bei größeren Paketen)."})]})]}),e.jsxs($,{sx:{p:3,mb:3},children:[e.jsx(i,{variant:"h6",sx:{mb:3,fontWeight:600},children:"Plattform-Nachricht"}),e.jsx(H,{label:"Nachricht an alle Benutzer (optional)",multiline:!0,rows:4,fullWidth:!0,value:g.platform_message||"",onChange:u=>c({...g,platform_message:u.target.value||null}),placeholder:"Z.B.: 'Willkommen in der Beta-Phase! Bitte melden Sie Bugs an office@ssi.at'",helperText:"Diese Nachricht wird allen Benutzern auf der Startseite angezeigt"})]}),e.jsx(d,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(I,{variant:"contained",size:"large",startIcon:e.jsx(Qe,{size:20}),onClick:P,disabled:C,children:C?"Speichert...":"Einstellungen speichern"})}),e.jsx(ge,{open:y.open,autoHideDuration:6e3,onClose:()=>A({...y,open:!1}),children:e.jsx(M,{severity:y.severity,onClose:()=>A({...y,open:!1}),children:y.message})})]})},os=()=>{const p=Re(),{getAllUsers:_,suspendUser:S,unsuspendUser:k,deleteUser:C,updateUserTokens:w,getUserRoles:y,assignRole:A,removeRole:g,getAllRoles:c}=je(),[B,P]=o.useState([]),[u,V]=o.useState(!1),[R,f]=o.useState({open:!1,message:"",severity:"success"}),[U,K]=o.useState(null),[t,l]=o.useState(null),[j,x]=o.useState(!1),[T,ce]=o.useState(""),[pe,F]=o.useState(!1),[de,O]=o.useState(!1),[he,ue]=o.useState(0),[fe,Y]=o.useState(!1),[J,Z]=o.useState([]),[W,ye]=o.useState([]);o.useEffect(()=>{E()},[]);const E=async()=>{V(!0);try{const n=await _(),m=await Promise.all(n.map(async X=>{const be=await y(X.id);return{...X,roles:be}}));P(m)}catch(n){f({open:!0,message:`Fehler beim Laden: ${n.message}`,severity:"error"})}finally{V(!1)}},s=(n,m)=>{K(n.currentTarget),l(m)},r=()=>{K(null)},b=async()=>{if(t){try{await S(t.id,T),f({open:!0,message:"Benutzer erfolgreich gesperrt",severity:"success"}),x(!1),ce(""),await E()}catch(n){f({open:!0,message:`Fehler: ${n.message}`,severity:"error"})}r()}},z=async()=>{if(t){try{await k(t.id),f({open:!0,message:"Sperrung erfolgreich aufgehoben",severity:"success"}),await E()}catch(n){f({open:!0,message:`Fehler: ${n.message}`,severity:"error"})}r()}},q=async()=>{if(t){try{await C(t.id),f({open:!0,message:"Benutzer erfolgreich gelöscht",severity:"success"}),F(!1),await E()}catch(n){f({open:!0,message:`Fehler: ${n.message}`,severity:"error"})}r()}},Q=async()=>{if(t){try{await w(t.id,he),f({open:!0,message:"Token-Guthaben erfolgreich aktualisiert",severity:"success"}),O(!1),await E()}catch(n){f({open:!0,message:`Fehler: ${n.message}`,severity:"error"})}r()}},xe=n=>new Date(n).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});return u&&B.length===0?e.jsx(d,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(we,{})}):e.jsxs(d,{children:[e.jsxs($,{children:[e.jsx(d,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:e.jsxs(i,{variant:"h6",sx:{fontWeight:600},children:["Benutzerverwaltung (",B.length," Benutzer)"]})}),e.jsx(Ce,{children:e.jsxs(Te,{children:[e.jsx(ze,{children:e.jsxs(N,{children:[e.jsx(a,{children:"E-Mail"}),e.jsx(a,{children:"Name"}),e.jsx(a,{children:"Rollen"}),e.jsx(a,{children:"Registriert"}),e.jsx(a,{align:"center",children:"Status"}),e.jsx(a,{align:"center",children:"Tokens"}),e.jsx(a,{align:"center",children:"Items"}),e.jsx(a,{align:"center",children:"Nachrichten"}),e.jsx(a,{align:"center",children:"Aktionen"})]})}),e.jsx(Ae,{children:B.map(n=>e.jsxs(N,{hover:!0,children:[e.jsxs(a,{children:[n.email,n.is_admin&&e.jsx(D,{label:"Super Admin",size:"small",color:"error",sx:{ml:1}})]}),e.jsx(a,{children:n.full_name||"-"}),e.jsx(a,{children:e.jsx(d,{display:"flex",gap:.5,flexWrap:"wrap",children:n.roles&&n.roles.length>0?n.roles.map(m=>e.jsx(D,{label:m.display_name,size:"small",variant:"outlined"},m.role_id)):e.jsx(i,{variant:"body2",color:"text.secondary",children:"-"})})}),e.jsx(a,{children:xe(n.created_at)}),e.jsx(a,{align:"center",children:n.is_suspended?e.jsx(Ye,{title:n.suspended_reason||"Gesperrt",children:e.jsx(D,{label:"Gesperrt",size:"small",color:"error"})}):e.jsx(D,{label:"Aktiv",size:"small",color:"success"})}),e.jsx(a,{align:"center",children:n.token_balance}),e.jsx(a,{align:"center",children:e.jsx(D,{label:n.item_count,size:"small",variant:"outlined",onClick:()=>p(`/?seller=${n.id}`),sx:{cursor:"pointer"}})}),e.jsx(a,{align:"center",children:n.message_count}),e.jsx(a,{align:"center",children:e.jsx(We,{size:"small",onClick:m=>s(m,n),disabled:n.is_admin,children:e.jsx(Ie,{size:20})})})]},n.id))})]})})]}),e.jsxs(Me,{anchorEl:U,open:!!U,onClose:r,children:[e.jsxs(h,{onClick:async()=>{if(t){const n=await y(t.id),m=await c();Z(n),ye(m),Y(!0)}},children:[e.jsx(Se,{size:18,style:{marginRight:8}}),"Rollen verwalten"]}),e.jsxs(h,{onClick:()=>{ue((t==null?void 0:t.token_balance)||0),O(!0)},children:[e.jsx($e,{size:18,style:{marginRight:8}}),"Tokens bearbeiten"]}),e.jsxs(h,{onClick:()=>t&&p(`/?seller=${t.id}`),children:[e.jsx(Le,{size:18,style:{marginRight:8}}),"Items anzeigen"]}),t!=null&&t.is_suspended?e.jsxs(h,{onClick:z,children:[e.jsx(He,{size:18,style:{marginRight:8}}),"Entsperren"]}):e.jsxs(h,{onClick:()=>x(!0),sx:{color:"warning.main"},children:[e.jsx(ns,{size:18,style:{marginRight:8}}),"Sperren"]}),e.jsxs(h,{onClick:()=>F(!0),sx:{color:"error.main"},children:[e.jsx(Pe,{size:18,style:{marginRight:8}}),"Löschen"]})]}),e.jsxs(te,{open:j,onClose:()=>x(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:"Benutzer sperren"}),e.jsxs(re,{children:[e.jsx(M,{severity:"warning",sx:{mb:2},children:"Der Benutzer kann sich nicht mehr anmelden und keine Items erstellen oder bearbeiten."}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Benutzer: ",e.jsx("strong",{children:t==null?void 0:t.email})]}),e.jsx(H,{label:"Grund für Sperrung",fullWidth:!0,multiline:!0,rows:3,value:T,onChange:n=>ce(n.target.value),placeholder:"Z.B.: Verstoß gegen Nutzungsbedingungen"})]}),e.jsxs(ie,{children:[e.jsx(I,{onClick:()=>x(!1),children:"Abbrechen"}),e.jsx(I,{variant:"contained",color:"warning",onClick:b,disabled:!T.trim(),children:"Sperren"})]})]}),e.jsxs(te,{open:pe,onClose:()=>F(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:"Benutzer löschen"}),e.jsxs(re,{children:[e.jsx(M,{severity:"error",sx:{mb:2},children:"Diese Aktion kann nicht rückgängig gemacht werden! Alle Daten des Benutzers werden unwiderruflich gelöscht."}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Benutzer: ",e.jsx("strong",{children:t==null?void 0:t.email})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Items: ",e.jsx("strong",{children:t==null?void 0:t.item_count})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Nachrichten: ",e.jsx("strong",{children:t==null?void 0:t.message_count})]})]}),e.jsxs(ie,{children:[e.jsx(I,{onClick:()=>F(!1),children:"Abbrechen"}),e.jsx(I,{variant:"contained",color:"error",onClick:q,children:"Unwiderruflich löschen"})]})]}),e.jsxs(te,{open:de,onClose:()=>O(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:"Token-Guthaben bearbeiten"}),e.jsxs(re,{children:[e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Benutzer: ",e.jsx("strong",{children:t==null?void 0:t.email})]}),e.jsx(H,{label:"Token-Guthaben",type:"number",fullWidth:!0,value:he,onChange:n=>ue(parseInt(n.target.value)||0),inputProps:{min:0}})]}),e.jsxs(ie,{children:[e.jsx(I,{onClick:()=>O(!1),children:"Abbrechen"}),e.jsx(I,{variant:"contained",onClick:Q,children:"Speichern"})]})]}),e.jsxs(te,{open:fe,onClose:()=>Y(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:"Rollen verwalten"}),e.jsxs(re,{children:[e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Benutzer: ",e.jsx("strong",{children:t==null?void 0:t.email})]}),e.jsx(i,{variant:"subtitle2",sx:{mt:2,mb:1},children:"Aktuelle Rollen:"}),e.jsx(d,{display:"flex",gap:1,flexWrap:"wrap",mb:2,children:J.length>0?J.map(n=>e.jsx(D,{label:n.display_name,onDelete:async()=>{if(t)try{await g(t.id,n.role_id);const m=await y(t.id);Z(m),f({open:!0,message:"Rolle erfolgreich entfernt",severity:"success"}),await E()}catch(m){f({open:!0,message:`Fehler: ${m.message}`,severity:"error"})}}},n.role_id)):e.jsx(i,{variant:"body2",color:"text.secondary",children:"Keine Rollen zugewiesen"})}),e.jsx(i,{variant:"subtitle2",sx:{mt:3,mb:1},children:"Rolle hinzufügen:"}),e.jsx(d,{display:"flex",gap:1,flexWrap:"wrap",children:W.filter(n=>!J.some(m=>m.role_id===n.role_id)).map(n=>e.jsx(D,{label:n.display_name,onClick:async()=>{if(t)try{await A(t.id,n.role_id);const m=await y(t.id);Z(m),f({open:!0,message:"Rolle erfolgreich zugewiesen",severity:"success"}),await E()}catch(m){f({open:!0,message:`Fehler: ${m.message}`,severity:"error"})}},variant:"outlined",sx:{cursor:"pointer"}},n.role_id))})]}),e.jsx(ie,{children:e.jsx(I,{onClick:()=>Y(!1),children:"Schließen"})})]}),e.jsx(ge,{open:R.open,autoHideDuration:6e3,onClose:()=>f({...R,open:!1}),children:e.jsx(M,{severity:R.severity,onClose:()=>f({...R,open:!1}),children:R.message})})]})},cs=()=>{const{getAllRoles:p}=je(),[_,S]=o.useState([]),[k,C]=o.useState(!1),[w,y]=o.useState({open:!1,message:"",severity:"success"});o.useEffect(()=>{A()},[]);const A=async()=>{C(!0);try{const c=await p();S(c)}catch(c){console.error("Error loading roles:",c),y({open:!0,message:"Fehler beim Laden der Rollen",severity:"error"})}finally{C(!1)}},g=c=>{switch(c){case"admin":return"error";case"moderator":return"warning";case"support":return"info";case"content_reviewer":return"success";default:return"default"}};return k?e.jsx(d,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(we,{})}):e.jsxs(d,{children:[e.jsx(d,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:e.jsx(i,{variant:"h6",children:"Rollen & Berechtigungen"})}),e.jsx(G,{container:!0,spacing:3,mb:4,children:_.map(c=>e.jsx(G,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ae,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:e.jsxs(le,{sx:{display:"flex",flexDirection:"column",height:"100%",p:3},children:[e.jsxs(d,{display:"flex",alignItems:"center",mb:2,children:[e.jsx(Se,{size:24,style:{marginRight:8}}),e.jsx(i,{variant:"h6",component:"div",fontWeight:600,children:c.display_name})]}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:"auto",minHeight:40,display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis"},children:c.description}),e.jsxs(d,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{pt:2,mt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(d,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(Fe,{size:16}),e.jsx(i,{variant:"body2",fontWeight:500,children:c.user_count})]}),e.jsxs(d,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(is,{size:16}),e.jsx(i,{variant:"body2",fontWeight:500,children:c.permission_count})]})]})]})})},c.role_id))}),e.jsx($,{children:e.jsx(Ce,{children:e.jsxs(Te,{children:[e.jsx(ze,{children:e.jsxs(N,{children:[e.jsx(a,{children:"Rolle"}),e.jsx(a,{children:"Beschreibung"}),e.jsx(a,{align:"center",children:"Berechtigungen"}),e.jsx(a,{align:"center",children:"Benutzer"})]})}),e.jsx(Ae,{children:_.map(c=>e.jsxs(N,{children:[e.jsx(a,{children:e.jsx(D,{label:c.display_name,color:g(c.role_name),size:"small"})}),e.jsx(a,{children:c.description}),e.jsx(a,{align:"center",children:c.permission_count}),e.jsx(a,{align:"center",children:c.user_count})]},c.role_id))})]})})}),e.jsxs(d,{mt:3,children:[e.jsxs(M,{severity:"info",sx:{mb:2},children:[e.jsx(i,{variant:"body2",fontWeight:600,mb:1,children:"Verfügbare Rollen und Berechtigungen:"}),e.jsxs(i,{variant:"body2",component:"div",sx:{mt:1},children:["• ",e.jsx("strong",{children:"Administrator:"})," Vollzugriff auf alle Systemfunktionen inkl. Rollenverwaltung",e.jsx("br",{}),"• ",e.jsx("strong",{children:"Moderator:"})," Kann Inserate prüfen, freigeben, sperren und bearbeiten",e.jsx("br",{}),"• ",e.jsx("strong",{children:"Support:"})," Kann Benutzerdaten einsehen und bei Problemen helfen",e.jsx("br",{}),"• ",e.jsx("strong",{children:"Content Reviewer:"})," Kann Inhalte prüfen und freigeben"]})]}),e.jsxs(M,{severity:"success",children:[e.jsx(i,{variant:"body2",fontWeight:600,mb:1,children:"✓ Funktionen bereits aktiv:"}),e.jsxs(i,{variant:"body2",component:"div",children:["• Rollen können Benutzern über die Benutzerverwaltung zugewiesen werden",e.jsx("br",{}),"• Berechtigungen werden automatisch überprüft (items.view_all, items.edit_any, items.delete, etc.)",e.jsx("br",{}),"• Datenbank-Funktionen: approve_item(), reject_item(), feature_item() für Moderatoren",e.jsx("br",{}),"• RLS-Policies berücksichtigen Berechtigungen bei Items"]}),e.jsxs(i,{variant:"body2",component:"div",sx:{mt:2},children:[e.jsx("strong",{children:"Noch zu implementieren:"}),e.jsx("br",{}),"• UI-Integration für Moderatoren (Approve/Reject Buttons in der Item-Ansicht)",e.jsx("br",{}),"• Messages-Moderation UI",e.jsx("br",{}),"• Analytics-Dashboard für Support-Rolle"]})]})]}),e.jsx(ge,{open:w.open,autoHideDuration:6e3,onClose:()=>y({...w,open:!1}),children:e.jsx(M,{severity:w.severity,onClose:()=>y({...w,open:!1}),children:w.message})})]})},ds=()=>{const{user:p}=Be(),[_,S]=o.useState([]),[k,C]=o.useState([]),[w,y]=o.useState(!0),[A,g]=o.useState(!1),[c,B]=o.useState(null),[P,u]=o.useState({open:!1,message:"",severity:"success"}),[V,R]=o.useState(null),[f,U]=o.useState(null),[K,t]=o.useState("all"),[l,j]=o.useState(0),[x,T]=o.useState({title:"",description:"",category:"other",priority:"medium",status:"todo",estimated_hours:"",due_date:""});o.useEffect(()=>{F(),ce()},[]);const ce=async()=>{try{const r=await(await fetch("/TODO.md")).text();pe(r)}catch(s){console.error("Error loading TODO.md:",s)}},pe=s=>{const r=s.split(`
`),b=[];let z=null;for(let q=0;q<r.length;q++){const Q=r[q],xe=Q.match(/^## (.+)$/);if(xe){z&&b.push(z);const n=xe[1].trim(),m=n.match(/^([^\w\s]+)\s+(.+)$/);z={title:m?m[2]:n,emoji:m?m[1]:"📋",items:[],notes:[]};continue}if(z){const n=Q.match(/^(\s*)- \[([ x])\] (.+)$/);if(n){const be=Math.floor(n[1].length/2);z.items.push({text:n[3],checked:n[2]==="x",indent:be});continue}const m=Q.match(/\*\*Priorität:\*\*\s*(.+)$/);if(m){z.priority=m[1];continue}const X=Q.match(/\*\*Geschätzter Aufwand:\*\*\s*(.+)$/);if(X){z.estimatedHours=X[1];continue}}}z&&b.push(z),C(b.filter(q=>q.items.length>0))},F=async()=>{y(!0);try{const{data:s,error:r}=await v.from("admin_tasks").select("*").order("created_at",{ascending:!1});if(r)throw r;S(s||[])}catch(s){u({open:!0,message:`Fehler beim Laden: ${s.message}`,severity:"error"})}finally{y(!1)}},de=s=>{var r;s?(B(s),T({title:s.title,description:s.description||"",category:s.category,priority:s.priority,status:s.status,estimated_hours:((r=s.estimated_hours)==null?void 0:r.toString())||"",due_date:s.due_date?s.due_date.split("T")[0]:""})):(B(null),T({title:"",description:"",category:"other",priority:"medium",status:"todo",estimated_hours:"",due_date:""})),g(!0)},O=()=>{g(!1),B(null)},he=async()=>{if(!x.title.trim()){u({open:!0,message:"Bitte gib einen Titel ein",severity:"error"});return}try{const s={title:x.title.trim(),description:x.description.trim()||null,category:x.category,priority:x.priority,status:x.status,estimated_hours:x.estimated_hours?parseInt(x.estimated_hours):null,due_date:x.due_date||null};if(c){const{error:r}=await v.from("admin_tasks").update(s).eq("id",c.id);if(r)throw r;u({open:!0,message:"Task erfolgreich aktualisiert",severity:"success"})}else{const{error:r}=await v.from("admin_tasks").insert([{...s,created_by:p==null?void 0:p.id}]);if(r)throw r;u({open:!0,message:"Task erfolgreich erstellt",severity:"success"})}O(),F()}catch(s){u({open:!0,message:`Fehler: ${s.message}`,severity:"error"})}},ue=async s=>{if(confirm("Möchtest du diese Aufgabe wirklich löschen?"))try{const{error:r}=await v.from("admin_tasks").delete().eq("id",s);if(r)throw r;u({open:!0,message:"Task erfolgreich gelöscht",severity:"success"}),F()}catch(r){u({open:!0,message:`Fehler: ${r.message}`,severity:"error"})}},fe=async(s,r)=>{try{const{error:b}=await v.from("admin_tasks").update({status:r}).eq("id",s);if(b)throw b;F()}catch(b){u({open:!0,message:`Fehler: ${b.message}`,severity:"error"})}},Y=s=>({moderation:"Moderation",feature:"Feature",bug:"Bug",improvement:"Verbesserung",documentation:"Dokumentation",other:"Sonstiges"})[s]||s,J=s=>({low:"default",medium:"info",high:"warning",urgent:"error"})[s]||"default",Z=K==="all"?_:_.filter(s=>s.status===K),W={total:_.length,todo:_.filter(s=>s.status==="todo").length,in_progress:_.filter(s=>s.status==="in_progress").length,done:_.filter(s=>s.status==="done").length},ye=k.reduce((s,r)=>s+r.items.length,0),E=k.reduce((s,r)=>s+r.items.filter(b=>b.checked).length,0);return e.jsxs(d,{children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(i,{variant:"h6",sx:{fontWeight:600},children:"Task Management"}),e.jsx(I,{variant:"contained",startIcon:e.jsx(Je,{size:20}),onClick:()=>de(),children:"Neue Aufgabe"})]}),e.jsx($,{sx:{mb:3},children:e.jsxs(ke,{value:l,onChange:(s,r)=>j(r),children:[e.jsx(L,{label:`TODO-Liste (${E}/${ye})`}),e.jsx(L,{label:`Datenbank Tasks (${W.total})`})]})}),l===0?e.jsx(d,{children:k.length===0?e.jsx($,{sx:{p:4,textAlign:"center"},children:e.jsx(i,{variant:"body1",color:"text.secondary",children:"TODO.md wird geladen..."})}):e.jsx(d,{children:k.map((s,r)=>e.jsxs(Xe,{defaultExpanded:r<3,children:[e.jsx(es,{expandIcon:e.jsx(Oe,{size:20}),children:e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1.5,width:"100%"},children:[e.jsx(i,{sx:{fontSize:"1.5rem"},children:s.emoji}),e.jsxs(d,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",fontWeight:600,children:s.title}),e.jsxs(d,{sx:{display:"flex",gap:2,mt:.5},children:[e.jsxs(i,{variant:"caption",color:"text.secondary",children:[s.items.filter(b=>b.checked).length," / ",s.items.length," erledigt"]}),s.priority&&e.jsx(D,{label:s.priority,size:"small",color:s.priority.toLowerCase().includes("high")||s.priority.toLowerCase().includes("urgent")?"error":s.priority.toLowerCase().includes("medium")?"warning":"default",sx:{height:20}}),s.estimatedHours&&e.jsx(D,{label:s.estimatedHours,size:"small",variant:"outlined",sx:{height:20}})]})]})]})}),e.jsx(ss,{children:e.jsx(Ne,{dense:!0,children:s.items.map((b,z)=>e.jsxs(Ue,{sx:{pl:2+b.indent*3,py:.5},children:[e.jsx(ve,{sx:{minWidth:32},children:b.checked?e.jsx(Ke,{size:18,color:"#4caf50"}):e.jsx(rs,{size:18,color:"#9e9e9e"})}),e.jsx(_e,{primary:b.text,primaryTypographyProps:{sx:{textDecoration:b.checked?"line-through":"none",color:b.checked?"text.secondary":"text.primary",fontSize:"0.9rem"}}})]},z))})})]},r))})}):e.jsxs(d,{children:[e.jsxs(G,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(G,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ae,{children:e.jsxs(le,{children:[e.jsx(i,{color:"text.secondary",variant:"body2",children:"Gesamt"}),e.jsx(i,{variant:"h4",fontWeight:600,children:W.total})]})})}),e.jsx(G,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ae,{children:e.jsxs(le,{children:[e.jsx(i,{color:"text.secondary",variant:"body2",children:"Offen"}),e.jsx(i,{variant:"h4",fontWeight:600,color:"text.primary",children:W.todo})]})})}),e.jsx(G,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ae,{children:e.jsxs(le,{children:[e.jsx(i,{color:"text.secondary",variant:"body2",children:"In Arbeit"}),e.jsx(i,{variant:"h4",fontWeight:600,color:"info.main",children:W.in_progress})]})})}),e.jsx(G,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ae,{children:e.jsxs(le,{children:[e.jsx(i,{color:"text.secondary",variant:"body2",children:"Erledigt"}),e.jsx(i,{variant:"h4",fontWeight:600,color:"success.main",children:W.done})]})})})]}),e.jsx($,{sx:{mb:3},children:e.jsxs(ke,{value:K,onChange:(s,r)=>t(r),sx:{borderBottom:1,borderColor:"divider"},children:[e.jsx(L,{label:`Alle (${W.total})`,value:"all"}),e.jsx(L,{label:`Offen (${W.todo})`,value:"todo"}),e.jsx(L,{label:`In Arbeit (${W.in_progress})`,value:"in_progress"}),e.jsx(L,{label:`Erledigt (${W.done})`,value:"done"})]})}),e.jsx(Ce,{component:$,children:e.jsxs(Te,{children:[e.jsx(ze,{children:e.jsxs(N,{children:[e.jsx(a,{children:"Titel"}),e.jsx(a,{children:"Kategorie"}),e.jsx(a,{children:"Priorität"}),e.jsx(a,{children:"Status"}),e.jsx(a,{children:"Aufwand"}),e.jsx(a,{children:"Fällig am"}),e.jsx(a,{align:"right",children:"Aktionen"})]})}),e.jsx(Ae,{children:w?e.jsx(N,{children:e.jsx(a,{colSpan:7,align:"center",children:"Lädt..."})}):Z.length===0?e.jsx(N,{children:e.jsx(a,{colSpan:7,align:"center",children:"Keine Aufgaben gefunden"})}):Z.map(s=>e.jsxs(N,{children:[e.jsx(a,{children:e.jsxs(d,{children:[e.jsx(i,{variant:"body2",fontWeight:600,children:s.title}),s.description&&e.jsxs(i,{variant:"caption",color:"text.secondary",children:[s.description.substring(0,60),s.description.length>60?"...":""]})]})}),e.jsx(a,{children:e.jsx(D,{label:Y(s.category),size:"small",variant:"outlined"})}),e.jsx(a,{children:e.jsx(D,{label:s.priority,size:"small",color:J(s.priority)})}),e.jsx(a,{children:e.jsx(ee,{size:"small",sx:{minWidth:120},children:e.jsxs(se,{value:s.status,onChange:r=>fe(s.id,r.target.value),sx:{fontSize:"0.875rem"},children:[e.jsx(h,{value:"todo",children:"Offen"}),e.jsx(h,{value:"in_progress",children:"In Arbeit"}),e.jsx(h,{value:"done",children:"Erledigt"}),e.jsx(h,{value:"cancelled",children:"Abgebrochen"})]})})}),e.jsx(a,{children:s.estimated_hours?`${s.estimated_hours}h`:"-"}),e.jsx(a,{children:s.due_date?e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ts,{size:14}),e.jsx(i,{variant:"body2",children:new Date(s.due_date).toLocaleDateString("de-DE")})]}):"-"}),e.jsx(a,{align:"right",children:e.jsx(We,{size:"small",onClick:r=>{R(r.currentTarget),U(s)},children:e.jsx(Ie,{size:18})})})]},s.id))})]})}),e.jsxs(Me,{anchorEl:V,open:!!V,onClose:()=>{R(null),U(null)},children:[e.jsxs(h,{onClick:()=>{f&&de(f),R(null)},children:[e.jsx(ve,{children:e.jsx(Le,{size:18})}),e.jsx(_e,{children:"Bearbeiten"})]}),e.jsxs(h,{onClick:()=>{f&&ue(f.id),R(null),U(null)},children:[e.jsx(ve,{children:e.jsx(Pe,{size:18})}),e.jsx(_e,{children:"Löschen"})]})]})]}),e.jsxs(te,{open:A,onClose:O,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:c?"Aufgabe bearbeiten":"Neue Aufgabe erstellen"}),e.jsx(re,{children:e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:2,mt:2},children:[e.jsx(H,{label:"Titel",fullWidth:!0,required:!0,value:x.title,onChange:s=>T({...x,title:s.target.value})}),e.jsx(H,{label:"Beschreibung",fullWidth:!0,multiline:!0,rows:3,value:x.description,onChange:s=>T({...x,description:s.target.value})}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(me,{children:"Kategorie"}),e.jsxs(se,{value:x.category,label:"Kategorie",onChange:s=>T({...x,category:s.target.value}),children:[e.jsx(h,{value:"moderation",children:"Moderation"}),e.jsx(h,{value:"feature",children:"Feature"}),e.jsx(h,{value:"bug",children:"Bug"}),e.jsx(h,{value:"improvement",children:"Verbesserung"}),e.jsx(h,{value:"documentation",children:"Dokumentation"}),e.jsx(h,{value:"other",children:"Sonstiges"})]})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(me,{children:"Priorität"}),e.jsxs(se,{value:x.priority,label:"Priorität",onChange:s=>T({...x,priority:s.target.value}),children:[e.jsx(h,{value:"low",children:"Niedrig"}),e.jsx(h,{value:"medium",children:"Mittel"}),e.jsx(h,{value:"high",children:"Hoch"}),e.jsx(h,{value:"urgent",children:"Dringend"})]})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(me,{children:"Status"}),e.jsxs(se,{value:x.status,label:"Status",onChange:s=>T({...x,status:s.target.value}),children:[e.jsx(h,{value:"todo",children:"Offen"}),e.jsx(h,{value:"in_progress",children:"In Arbeit"}),e.jsx(h,{value:"done",children:"Erledigt"}),e.jsx(h,{value:"cancelled",children:"Abgebrochen"})]})]}),e.jsx(H,{label:"Geschätzter Aufwand (Stunden)",type:"number",fullWidth:!0,value:x.estimated_hours,onChange:s=>T({...x,estimated_hours:s.target.value})}),e.jsx(H,{label:"Fällig am",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},value:x.due_date,onChange:s=>T({...x,due_date:s.target.value})})]})}),e.jsxs(ie,{children:[e.jsx(I,{onClick:O,children:"Abbrechen"}),e.jsx(I,{onClick:he,variant:"contained",children:c?"Speichern":"Erstellen"})]})]}),e.jsx(ge,{open:P.open,autoHideDuration:6e3,onClose:()=>u({...P,open:!1}),children:e.jsx(M,{severity:P.severity,onClose:()=>u({...P,open:!1}),children:P.message})})]})},vs=()=>{const p=Re(),{isAdmin:_,loading:S}=je(),[k,C]=o.useState(0);return o.useEffect(()=>{!S&&!_&&p("/")},[_,S,p]),S?e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(we,{})}):_?e.jsxs(d,{sx:{display:"flex",flexDirection:"column",minHeight:"100vh"},children:[e.jsx(qe,{onNavigate:w=>{w==="items"?p("/"):w==="messages"?p("/messages"):w==="settings"&&p("/settings")},onLoginClick:()=>{},showSearch:!1}),e.jsx(d,{sx:{flex:1},children:e.jsxs(Ge,{maxWidth:"lg",sx:{py:4},children:[e.jsx(i,{variant:"h4",sx:{mb:3,fontWeight:600},children:"Admin-Bereich"}),e.jsx($,{sx:{mb:3},children:e.jsxs(ke,{value:k,onChange:(w,y)=>C(y),sx:{borderBottom:1,borderColor:"divider"},variant:"scrollable",scrollButtons:"auto",children:[e.jsx(L,{icon:e.jsx(Ve,{size:20}),label:"System-Einstellungen",iconPosition:"start",sx:{textTransform:"none",minHeight:56}}),e.jsx(L,{icon:e.jsx(Fe,{size:20}),label:"Benutzerverwaltung",iconPosition:"start",sx:{textTransform:"none",minHeight:56}}),e.jsx(L,{icon:e.jsx(Se,{size:20}),label:"Rollen & Berechtigungen",iconPosition:"start",sx:{textTransform:"none",minHeight:56}}),e.jsx(L,{icon:e.jsx(as,{size:20}),label:"Aufgaben",iconPosition:"start",sx:{textTransform:"none",minHeight:56}})]})}),k===0&&e.jsx(ls,{}),k===1&&e.jsx(os,{}),k===2&&e.jsx(cs,{}),k===3&&e.jsx(ds,{})]})}),e.jsx(Ze,{})]}):null};export{vs as default};
