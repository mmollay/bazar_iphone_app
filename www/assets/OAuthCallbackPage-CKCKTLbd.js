import{x,r as p,j as o,B as g,T as c,H as O,bo as w,bp as v,f as y}from"./index-VtLmrSoN.js";const E=()=>{const s=x(),[f,t]=p.useState(null);if(p.useEffect(()=>{(async()=>{try{const e=window.location.href,r=new URLSearchParams(window.location.search),b=r.get("platform")==="ios";if(console.log("[OAuth Callback] Processing URL:",e),console.log("[OAuth Callback] Platform:",b?"Native iOS (from URL param)":"Web"),console.log("[OAuth Callback] All URL parameters:"),r.forEach((n,l)=>{console.log(`  - ${l}: ${n}`)}),b){console.log("[OAuth Callback] Native iOS request detected - storing tokens...");const n=r.get("error"),l=r.get("error_description");if(n){console.error("[OAuth Callback] OAuth Error:",n),console.error("[OAuth Callback] Error Description:",l),t(`OAuth Fehler: ${l||n}`);return}const i=window.location.hash.substring(1);if(console.log("[OAuth Callback] URL Fragment:",i),!i){console.error("[OAuth Callback] No fragment found in URL"),console.error("[OAuth Callback] Full URL:",window.location.href),t("Keine Authentifizierungsdaten gefunden.");return}const m=new URLSearchParams(i),u=m.get("access_token"),h=m.get("refresh_token");if(console.log("[OAuth Callback] Access token present:",!!u),console.log("[OAuth Callback] Refresh token present:",!!h),!u||!h){console.error("[OAuth Callback] Missing tokens in fragment"),t("Authentifizierungsdaten unvollständig.");return}const A=JSON.stringify({access_token:u,refresh_token:h});console.log("[OAuth Callback] Storing tokens in Preferences..."),await w.set({key:"oauth_pending_tokens",value:A}),console.log("[OAuth Callback] Tokens stored successfully"),console.log("[OAuth Callback] Closing browser...");try{await v.close(),console.log("[OAuth Callback] Browser closed successfully")}catch(C){console.warn("[OAuth Callback] Could not close browser:",C),t("Anmeldung erfolgreich! Bitte wechsle zurück zur App.")}return}console.log("[OAuth Callback] Web platform - exchanging code for session...");const{error:k}=await y.auth.exchangeCodeForSession(e);if(k){console.error("[OAuth Callback] Exchange error:",k),t("Anmeldung fehlgeschlagen. Bitte versuche es erneut."),setTimeout(()=>s("/"),3e3);return}console.log("[OAuth Callback] Success! Redirecting to home..."),s("/",{replace:!0})}catch(e){console.error("[OAuth Callback] Error:",e),t("Ein Fehler ist aufgetreten. Du wirst weitergeleitet..."),setTimeout(()=>s("/"),3e3)}})()},[s]),f){const d=new URLSearchParams(window.location.search),e=[];return d.forEach((r,a)=>{e.push(`${a}: ${r}`)}),o.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",gap:2,p:3},children:[o.jsx(c,{variant:"h6",color:"error",children:f}),e.length>0&&o.jsxs(g,{sx:{mt:2,p:2,bgcolor:"#f5f5f5",borderRadius:1,width:"100%",maxWidth:500},children:[o.jsx(c,{variant:"subtitle2",sx:{mb:1,fontWeight:"bold"},children:"Debug Info:"}),e.map((r,a)=>o.jsx(c,{variant:"body2",sx:{fontFamily:"monospace",fontSize:"0.8rem"},children:r},a))]})]})}return o.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",gap:2},children:[o.jsx(O,{size:60}),o.jsx(c,{variant:"h6",children:"Anmeldung wird verarbeitet..."})]})};export{E as OAuthCallbackPage};
