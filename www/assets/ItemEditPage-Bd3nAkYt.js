import{g as is,a as ns,r as t,u as as,j as e,s as rs,c as ls,b as os,T as C,a9 as cs,B as a,P as Y,a6 as ds,a4 as A,aa as Q,w as ee,ab as qe,ac as He,Q as z,ad as hs,ae as us,t as L,_ as ps,L as T,z as gs,x as xs,n as ms,h as fs,i as js,f as j,H as Z,R as Re,A as X,l as w,af as bs,V as $e,X as ys,D as Cs,p as _s,q as Ss,v as vs}from"./index-5Tj7IyRr.js";import{M as ws,B as Ds,D as ks}from"./MultiImageUpload-Dq5V2ECL.js";import{C as Ke}from"./Collapse-BW40lBVK.js";import{R as As,a as J}from"./RadioGroup-U_qCFLAl.js";import{A as Oe}from"./arrow-left-DflRx_eF.js";import{S as zs}from"./save-PwjE54dR.js";import"./star-CF9bpsej.js";function Is(l){return is("MuiDialogContentText",l)}ns("MuiDialogContentText",["root"]);const Ws=l=>{const{classes:o}=l,_=os({root:["root"]},Is,o);return{...o,..._}},Es=rs(C,{shouldForwardProp:l=>cs(l)||l==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Ps=t.forwardRef(function(o,c){const _=as({props:o,name:"MuiDialogContentText"}),{children:r,className:I,...S}=_,b=Ws(S);return e.jsx(Es,{component:"p",variant:"body1",color:"textSecondary",ref:c,ownerState:S,className:ls(b.root,I),..._,classes:b})}),Bs=({shippingEnabled:l,shippingCostType:o,shippingCost:c,shippingDescription:_,pickupEnabled:r,selectedAddressId:I,showLocationPublicly:S,locationDescription:b,addresses:U,onShippingEnabledChange:D,onShippingCostTypeChange:h,onShippingCostChange:H,onShippingDescriptionChange:R,onPickupEnabledChange:u,onSelectedAddressChange:$,onShowLocationPubliclyChange:M,onLocationDescriptionChange:W,isMobile:v=!1,hideShippingPickupToggles:p=!1})=>{const[g,E]=t.useState(!0),[x,P]=t.useState(!0),k=U.filter(i=>i.address_type==="pickup_only"||i.address_type==="both");return e.jsxs(a,{children:[!p&&e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Versand & Abholung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2},children:[l&&e.jsxs(Y,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!p&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:g?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>E(!g),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ds,{size:20,color:"#1976d2"}),e.jsx(C,{variant:"subtitle1",fontWeight:600,children:"Versand"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{control:e.jsx(Q,{checked:l,onChange:i=>{i.stopPropagation(),D(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ee,{size:"small",onClick:()=>E(!g),children:g?e.jsx(qe,{size:20}):e.jsx(He,{size:20})})]})]}),e.jsxs(Ke,{in:p||g&&l,children:[!p&&e.jsx(z,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(hs,{children:[e.jsx(us,{children:"Versandkosten"}),e.jsxs(As,{value:o,onChange:i=>h(i.target.value),children:[e.jsx(A,{value:"free",control:e.jsx(J,{}),label:"Kostenloser Versand"}),e.jsx(A,{value:"fixed",control:e.jsx(J,{}),label:"Fester Betrag"}),e.jsx(A,{value:"ai_calculated",control:e.jsx(J,{}),label:"KI-berechnet (basierend auf Gewicht & Maßen)"})]})]}),o==="fixed"&&e.jsx(L,{label:"Versandkosten",type:"number",value:c,onChange:i=>H(parseFloat(i.target.value)||0),fullWidth:!0,inputProps:{min:0,step:.5},helperText:"in Euro (€)"}),e.jsx(L,{label:"Versandinformationen",value:_,onChange:i=>R(i.target.value),fullWidth:!0,multiline:!0,rows:v?2:3,placeholder:"z.B. Versand mit DHL, 1-3 Werktage"})]})]})]}),r&&e.jsxs(Y,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!p&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:x?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>P(!x),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ps,{size:20,color:"#1976d2"}),e.jsx(C,{variant:"subtitle1",fontWeight:600,children:"Abholung"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{control:e.jsx(Q,{checked:r,onChange:i=>{i.stopPropagation(),u(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ee,{size:"small",onClick:()=>P(!x),children:x?e.jsx(qe,{size:20}):e.jsx(He,{size:20})})]})]}),e.jsxs(Ke,{in:p||x&&r,children:[!p&&e.jsx(z,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(L,{label:"Abholadresse",value:I,onChange:i=>$(i.target.value),fullWidth:!0,select:!0,helperText:k.length===0?"Bitte füge eine Abholadresse in den Einstellungen hinzu":"",children:k.length===0?e.jsx(T,{value:"",children:"Keine Adresse verfügbar"}):k.map(i=>e.jsx(T,{value:i.id,children:e.jsxs(a,{children:[e.jsx(C,{variant:"body2",fontWeight:600,children:i.name}),e.jsxs(C,{variant:"caption",color:"text.secondary",children:[i.address,", ",i.postal_code," ",i.city]})]})},i.id))}),e.jsx(A,{control:e.jsx(Q,{checked:S,onChange:i=>M(i.target.checked)}),label:"Vollständige Adresse öffentlich anzeigen"}),e.jsx(L,{label:"Abholhinweise",value:b,onChange:i=>W(i.target.value),fullWidth:!0,multiline:!0,rows:v?2:3,placeholder:"z.B. Hinterhof, Klingel oben rechts"})]})]})]})]})]})},qs=()=>{const{id:l}=gs(),o=xs(),{user:c}=ms(),_=fs(),r=js(_.breakpoints.down("md")),[I,S]=t.useState(!0),[b,U]=t.useState(!1),[D,h]=t.useState(null),[H,R]=t.useState(!1),[u,$]=t.useState(null),[M,W]=t.useState([]),[v,p]=t.useState(""),[g,E]=t.useState(""),[x,P]=t.useState(""),[k,i]=t.useState(""),[se,te]=t.useState(""),[ie,ne]=t.useState(""),[K,ae]=t.useState([]),[re,le]=t.useState("published"),[Ge,V]=t.useState(!1),[F,oe]=t.useState(!1),[ce,de]=t.useState(""),[he,ue]=t.useState(""),[pe,ge]=t.useState(""),[xe,me]=t.useState(""),[fe,je]=t.useState(""),[be,ye]=t.useState(""),[O,Ce]=t.useState([]),[_e,Se]=t.useState(""),[ve,we]=t.useState(""),[De,ke]=t.useState(!1),[G,Ae]=t.useState("fixed"),[ze,Ie]=t.useState(5),[We,Ee]=t.useState(""),[N,Pe]=t.useState(!0),[B,Be]=t.useState(""),[Le,Te]=t.useState(!1),[Ue,Me]=t.useState(""),[Qe,Ze]=t.useState([]);t.useEffect(()=>{if(!c){o("/");return}Xe(),Je()},[l,c]);const Xe=async()=>{var n;if(!(!l||!c))try{const{data:s,error:y}=await j.from("items").select("*").eq("id",l).maybeSingle();if(y)throw y;if(!s){h("Artikel nicht gefunden"),S(!1);return}if(s.user_id!==c.id){h("Keine Berechtigung zum Bearbeiten dieses Artikels"),S(!1);return}$(s),p(s.title||""),E(s.description||""),P(((n=s.price)==null?void 0:n.toString())||""),i(s.category||""),te(s.brand||""),ne(s.condition||""),ae(s.tags||[]),le(s.status||"published"),de(s.size||""),ue(s.weight||""),ge(s.dimensions_length||""),me(s.dimensions_width||""),je(s.dimensions_height||""),ye(s.material||""),Ce(s.colors||[]),Se(s.style||""),we(s.serial_number||""),ke(s.snapshot_shipping_enabled||!1),Ae(s.snapshot_shipping_cost_type||"fixed"),Ie(s.snapshot_shipping_cost||5),Ee(s.snapshot_shipping_description||""),Pe(s.snapshot_pickup_enabled||!1),Be(s.selected_address_id||""),Te(s.snapshot_show_location_publicly||!1),Me(s.snapshot_location_description||"");const{data:m}=await j.from("item_images").select("*").eq("item_id",l).order("display_order",{ascending:!0});m&&m.length>0?W(m.map(f=>({id:f.id,preview:f.image_url,existingUrl:f.image_url,isPrimary:f.is_primary}))):s.image_url&&W([{id:"primary",preview:s.image_url,existingUrl:s.image_url,isPrimary:!0}])}catch(s){console.error("Error loading item:",s),h("Fehler beim Laden des Artikels")}finally{S(!1)}},Je=async()=>{if(c)try{const{data:n,error:s}=await j.from("addresses").select("*").eq("user_id",c.id).in("address_type",["pickup_only","both"]).order("is_default",{ascending:!1});if(s)throw s;Ze(n||[])}catch(n){console.error("Error loading addresses:",n)}},Ye=async()=>{if(!(!c||!u)){oe(!0),h(null);try{const{error:n}=await j.from("items").delete().eq("id",u.id);if(n)throw n;o("/")}catch(n){console.error("Error deleting item:",n),h(n.message||"Fehler beim Löschen"),oe(!1),V(!1)}}},es=async()=>{if(!(!c||!u)){if(!v.trim()||!g.trim()||!x){h("Bitte fülle alle Pflichtfelder aus");return}U(!0),h(null);try{const n=parseFloat(x.replace(",","."));if(isNaN(n))throw new Error("Ungültiger Preis");let s=u.image_url;await j.from("item_images").delete().eq("item_id",u.id);const y=[];for(const d of M){let q;if(d.file){const ss=d.file.name.split(".").pop(),Fe=`${c.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${ss}`,{error:Ne}=await j.storage.from("item-images").upload(Fe,d.file);if(Ne)throw Ne;const{data:{publicUrl:ts}}=j.storage.from("item-images").getPublicUrl(Fe);q=ts}else if(d.existingUrl)q=d.existingUrl;else continue;y.push(q),d.isPrimary&&(s=q)}for(let d=0;d<y.length;d++)await j.from("item_images").insert({item_id:u.id,image_url:y[d],display_order:d,is_primary:y[d]===s});let m=null;if(N&&B){const{data:d}=await j.from("addresses").select("*").eq("id",B).maybeSingle();m=d}const f={title:v.trim(),description:g.trim(),price:n,category:k||null,brand:se||null,condition:ie||null,tags:K.length>0?K:null,status:re,size:ce||null,weight:he||null,dimensions_length:pe||null,dimensions_width:xe||null,dimensions_height:fe||null,material:be||null,colors:O.length>0?O:null,style:_e||null,serial_number:ve||null,image_url:s,selected_address_id:N&&B?B:null,snapshot_shipping_enabled:De,snapshot_shipping_cost_type:G,snapshot_shipping_cost:G==="fixed"?ze:0,snapshot_shipping_description:We||null,snapshot_pickup_enabled:N,snapshot_show_location_publicly:Le,snapshot_location_description:Ue||null,updated_at:new Date().toISOString()};m&&(f.snapshot_pickup_address=m.address,f.snapshot_pickup_postal_code=m.postal_code,f.snapshot_pickup_city=m.city,f.snapshot_pickup_country=m.country);const{error:Ve}=await j.from("items").update(f).eq("id",u.id);if(Ve)throw Ve;R(!0),setTimeout(()=>{o(`/item/${u.id}`)},1500)}catch(n){console.error("Error saving item:",n),h(n.message||"Fehler beim Speichern")}finally{U(!1)}}};return I?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:e.jsx(Z,{})}):D&&!u?e.jsx(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:e.jsxs(Re,{maxWidth:"md",sx:{py:8,flex:1},children:[e.jsx(X,{severity:"error",children:D}),e.jsx(w,{variant:"outlined",onClick:()=>o("/"),sx:{mt:2},startIcon:e.jsx(Oe,{size:20}),children:"Zurück zur Startseite"})]})}):e.jsxs(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",bgcolor:"#fafafa"},children:[e.jsxs(Re,{maxWidth:"lg",sx:{py:r?2:4,flex:1,maxWidth:"1200px !important"},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2,flex:1},children:[e.jsx(ee,{onClick:()=>o(`/item/${l}`),size:r?"small":"medium",children:e.jsx(Oe,{size:r?20:24})}),e.jsx(C,{variant:r?"h5":"h4",fontWeight:600,children:"Artikel bearbeiten"})]}),!r&&e.jsx(w,{variant:"outlined",onClick:()=>o("/"),startIcon:e.jsx(bs,{size:20}),sx:{whiteSpace:"nowrap"},children:"Zurück zur Liste"})]}),D&&e.jsx(X,{severity:"error",sx:{mb:3},onClose:()=>h(null),children:D}),H&&e.jsx(X,{severity:"success",sx:{mb:3},children:"Artikel erfolgreich aktualisiert! Du wirst weitergeleitet..."}),e.jsxs(Y,{elevation:r?0:1,sx:{p:r?2:4},children:[e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:4},children:[e.jsxs(a,{children:[e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Bilder"}),e.jsx(ws,{images:M,onImagesChange:W})]}),e.jsx(z,{}),e.jsx(Ds,{title:v,description:g,price:x,category:k,brand:se,condition:ie,tags:K,onTitleChange:p,onDescriptionChange:E,onPriceChange:P,onCategoryChange:i,onBrandChange:te,onConditionChange:ne,onTagsChange:ae,isMobile:r}),e.jsx(z,{}),e.jsx(ks,{size:ce,weight:he,dimensionsLength:pe,dimensionsWidth:xe,dimensionsHeight:fe,material:be,colors:O,style:_e,serialNumber:ve,onSizeChange:de,onWeightChange:ue,onDimensionsChange:(n,s,y)=>{ge(n),me(s),je(y)},onMaterialChange:ye,onColorsChange:Ce,onStyleChange:Se,onSerialNumberChange:we,isMobile:r}),e.jsx(z,{}),e.jsx(Bs,{shippingEnabled:De,shippingCostType:G,shippingCost:ze,shippingDescription:We,pickupEnabled:N,selectedAddressId:B,showLocationPublicly:Le,locationDescription:Ue,addresses:Qe,onShippingEnabledChange:ke,onShippingCostTypeChange:Ae,onShippingCostChange:Ie,onShippingDescriptionChange:Ee,onPickupEnabledChange:Pe,onSelectedAddressChange:Be,onShowLocationPubliclyChange:Te,onLocationDescriptionChange:Me,isMobile:r}),e.jsx(z,{}),e.jsxs(a,{children:[e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Status & Verwaltung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2.5},children:[e.jsxs(L,{label:"Artikelstatus",value:re,onChange:n=>le(n.target.value),select:!0,fullWidth:!0,helperText:"Entwürfe sind nur für dich sichtbar",children:[e.jsx(T,{value:"draft",children:"Entwurf"}),e.jsx(T,{value:"published",children:"Veröffentlicht"}),e.jsx(T,{value:"sold",children:"Verkauft"})]}),e.jsx(w,{variant:"outlined",color:"error",onClick:()=>V(!0),startIcon:e.jsx($e,{size:20}),fullWidth:r,sx:{alignSelf:r?"stretch":"flex-start"},children:"Artikel löschen"})]})]})]}),e.jsxs(a,{sx:{mt:4,display:"flex",gap:2,justifyContent:"flex-end",flexWrap:"wrap"},children:[e.jsx(w,{variant:"outlined",onClick:()=>o(`/item/${l}`),startIcon:e.jsx(ys,{size:20}),disabled:b,fullWidth:r,children:"Abbrechen"}),e.jsx(w,{variant:"contained",onClick:es,disabled:b||!v.trim()||!g.trim()||!x,startIcon:b?e.jsx(Z,{size:20,color:"inherit"}):e.jsx(zs,{size:20}),fullWidth:r,children:b?"Speichern...":"Änderungen speichern"})]})]})]}),e.jsxs(Cs,{open:Ge,onClose:()=>V(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(_s,{children:"Artikel löschen?"}),e.jsx(Ss,{children:e.jsx(Ps,{children:"Möchtest du diesen Artikel wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden."})}),e.jsxs(vs,{children:[e.jsx(w,{onClick:()=>V(!1),disabled:F,children:"Abbrechen"}),e.jsx(w,{onClick:Ye,color:"error",variant:"contained",disabled:F,startIcon:F?e.jsx(Z,{size:20,color:"inherit"}):e.jsx($e,{size:20}),children:F?"Lösche...":"Löschen"})]})]})]})};export{qs as ItemEditPage};
