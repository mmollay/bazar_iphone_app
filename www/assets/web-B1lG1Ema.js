import{bo as p}from"./index-B2WlVyYH.js";class d{static getAppId(e){return this.getOverwritableValue(e,"appId")}static getOverwritableValue(e,r){let t=e[r];return e.web&&r in e.web&&(t=e.web[r]),t}static getAuthorizationUrl(e){let r=e.authorizationBaseUrl+"?client_id="+e.appId;if(r+="&response_type="+e.responseType,e.redirectUrl&&(r+="&redirect_uri="+e.redirectUrl),e.scope&&(r+="&scope="+e.scope),r+="&state="+e.state,e.additionalParameters)for(const t in e.additionalParameters)r+="&"+t+"="+e.additionalParameters[t];return e.pkceCodeChallenge&&(r+="&code_challenge="+e.pkceCodeChallenge,r+="&code_challenge_method="+e.pkceCodeChallengeMethod),encodeURI(r)}static getTokenEndpointData(e,r){let t="";return t+=encodeURIComponent("grant_type")+"="+encodeURIComponent("authorization_code")+"&",t+=encodeURIComponent("client_id")+"="+encodeURIComponent(e.appId)+"&",t+=encodeURIComponent("redirect_uri")+"="+encodeURIComponent(e.redirectUrl)+"&",t+=encodeURIComponent("code")+"="+encodeURIComponent(r)+"&",t+=encodeURIComponent("code_verifier")+"="+encodeURIComponent(e.pkceCodeVerifier),t}static setCodeVerifier(e){try{return window.sessionStorage.setItem("I_Capacitor_GenericOAuth2Plugin_PKCE",e),!0}catch{return!1}}static clearCodeVerifier(){window.sessionStorage.removeItem("I_Capacitor_GenericOAuth2Plugin_PKCE")}static getCodeVerifier(){return window.sessionStorage.getItem("I_Capacitor_GenericOAuth2Plugin_PKCE")}static getUrlParams(e){const r=`${e??""}`.trim();if(r.length===0)return;const t=new URL(r);if(!t.search&&!t.hash)return;let i;return t.search?i=t.search.substr(1):i=t.hash.substr(1),i.split("&").reduce((s,n)=>{const[l,a]=n.split("=");if(l&&l.length>0)return Object.assign(Object.assign({},s),{[l]:decodeURIComponent(a)})},{})}static randomString(e=10){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";let t;if(window.crypto){let i=new Uint32Array(e);window.crypto.getRandomValues(i),i=i.map(s=>r.charCodeAt(s%r.length));const o=[];i.forEach(s=>{o.push(r.charAt(s%r.length))}),t=o.join("")}else{t="";for(let i=0;i<e;i++)t+=r.charAt(Math.floor(Math.random()*r.length))}return t}static async buildWebOptions(e){var r;const t=new u;if(t.appId=this.getAppId(e),t.authorizationBaseUrl=this.getOverwritableValue(e,"authorizationBaseUrl"),t.responseType=this.getOverwritableValue(e,"responseType"),t.responseType||(t.responseType="token"),t.redirectUrl=this.getOverwritableValue(e,"redirectUrl"),t.resourceUrl=this.getOverwritableValue(e,"resourceUrl"),t.accessTokenEndpoint=this.getOverwritableValue(e,"accessTokenEndpoint"),t.pkceEnabled=this.getOverwritableValue(e,"pkceEnabled"),t.sendCacheControlHeader=(r=this.getOverwritableValue(e,"sendCacheControlHeader"))!==null&&r!==void 0?r:t.sendCacheControlHeader,t.pkceEnabled){const s=this.getCodeVerifier();s?t.pkceCodeVerifier=s:(t.pkceCodeVerifier=this.randomString(64),this.setCodeVerifier(t.pkceCodeVerifier)),c.HAS_SUBTLE_CRYPTO?await c.deriveChallenge(t.pkceCodeVerifier).then(n=>{t.pkceCodeChallenge=n,t.pkceCodeChallengeMethod="S256"}):(t.pkceCodeChallenge=t.pkceCodeVerifier,t.pkceCodeChallengeMethod="plain")}t.scope=this.getOverwritableValue(e,"scope"),t.state=this.getOverwritableValue(e,"state"),(!t.state||t.state.length===0)&&(t.state=this.randomString(20));const i=this.getOverwritableValue(e,"additionalParameters");if(i){t.additionalParameters={};for(const s in i)if(s&&s.trim().length>0){const n=i[s];n&&n.trim().length>0&&(t.additionalParameters[s]=n)}}const o=this.getOverwritableValue(e,"additionalResourceHeaders");if(o){t.additionalResourceHeaders={};for(const s in o)if(s&&s.trim().length>0){const n=o[s];n&&n.trim().length>0&&(t.additionalResourceHeaders[s]=n)}}return t.logsEnabled=this.getOverwritableValue(e,"logsEnabled"),t}static buildWindowOptions(e){const r=new u;return e.web&&(e.web.windowOptions&&(r.windowOptions=e.web.windowOptions),e.web.windowTarget&&(r.windowTarget=e.web.windowTarget)),r}}class c{static toUint8Array(e){const r=new ArrayBuffer(e.length),t=new Uint8Array(r);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}static toBase64Url(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}static toBase64(e){const r=e.length;let t="";for(let i=0;i<r;i+=3)t+=this.BASE64_CHARS[e[i]>>2],t+=this.BASE64_CHARS[(e[i]&3)<<4|e[i+1]>>4],t+=this.BASE64_CHARS[(e[i+1]&15)<<2|e[i+2]>>6],t+=this.BASE64_CHARS[e[i+2]&63];return r%3===2?t=t.substring(0,t.length-1)+"=":r%3===1&&(t=t.substring(0,t.length-2)+"=="),t}static deriveChallenge(e){return e.length<43||e.length>128?Promise.reject(new Error("ERR_PKCE_CODE_VERIFIER_INVALID_LENGTH")):c.HAS_SUBTLE_CRYPTO?new Promise((r,t)=>{crypto.subtle.digest("SHA-256",this.toUint8Array(e)).then(i=>r(this.toBase64Url(this.toBase64(new Uint8Array(i)))),i=>t(i))}):Promise.reject(new Error("ERR_PKCE_CRYPTO_NOTSUPPORTED"))}}c.BASE64_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";c.HAS_SUBTLE_CRYPTO=typeof window<"u"&&!!window.crypto&&!!window.crypto.subtle;class u{constructor(){this.sendCacheControlHeader=!0,this.windowTarget="_blank"}}class R extends p{constructor(){super(...arguments),this.loopCount=2e3,this.intervalLength=100,this.MSG_RETURNED_TO_JS="Returned to JS:"}async refreshToken(e){return new Promise((r,t)=>{t(new Error("Functionality not implemented for PWAs yet"))})}async redirectFlowCodeListener(e){return this.webOptions=await d.buildWebOptions(e),new Promise((r,t)=>{const i=d.getUrlParams(e.response_url);if(i){const o=i.code;o?this.getAccessToken(i,r,t,o):t(new Error("Oauth Code parameter was not present in url."))}else t(new Error("Oauth Parameters where not present in url."))})}async authenticate(e){const r=d.buildWindowOptions(e);return this.windowHandle=window.open("",r.windowTarget,r.windowOptions),this.webOptions=await d.buildWebOptions(e),new Promise((t,i)=>{if(!this.webOptions.appId||this.webOptions.appId.length==0)i(new Error("ERR_PARAM_NO_APP_ID"));else if(!this.webOptions.authorizationBaseUrl||this.webOptions.authorizationBaseUrl.length==0)i(new Error("ERR_PARAM_NO_AUTHORIZATION_BASE_URL"));else if(!this.webOptions.redirectUrl||this.webOptions.redirectUrl.length==0)i(new Error("ERR_PARAM_NO_REDIRECT_URL"));else if(!this.webOptions.responseType||this.webOptions.responseType.length==0)i(new Error("ERR_PARAM_NO_RESPONSE_TYPE"));else{let o=this.loopCount;this.windowClosedByPlugin=!1;const s=d.getAuthorizationUrl(this.webOptions);this.webOptions.logsEnabled&&this.doLog("Authorization url: "+s),this.windowHandle&&(this.windowHandle.location.href=s),this.intervalId=window.setInterval(()=>{var n;if(o--<0)this.closeWindow();else if(!((n=this.windowHandle)===null||n===void 0)&&n.closed&&!this.windowClosedByPlugin)window.clearInterval(this.intervalId),i(new Error("USER_CANCELLED"));else{let l;try{l=this.windowHandle.location.href}catch{}if(l!=null&&l.indexOf(this.webOptions.redirectUrl)>=0){this.webOptions.logsEnabled&&this.doLog("Url from Provider: "+l);const a=d.getUrlParams(l);if(a)if(this.webOptions.logsEnabled&&this.doLog("Authorization response:",a),window.clearInterval(this.intervalId),a.state===this.webOptions.state)if(this.webOptions.accessTokenEndpoint){const w=a.code;w?this.getAccessToken(a,t,i,w):i(new Error("ERR_NO_AUTHORIZATION_CODE")),this.closeWindow()}else this.requestResource(a.access_token,t,i,a);else this.webOptions.logsEnabled&&(this.doLog("State from web options: "+this.webOptions.state),this.doLog("State returned from provider: "+a.state)),i(new Error("ERR_STATES_NOT_MATCH")),this.closeWindow()}}},this.intervalLength)}})}getAccessToken(e,r,t,i){const o=new XMLHttpRequest;o.onload=()=>{if(d.clearCodeVerifier(),o.status===200){const s=JSON.parse(o.response);this.webOptions.logsEnabled&&this.doLog("Access token response:",s),this.requestResource(s.access_token,r,t,e,s)}},o.onerror=()=>{this.doLog("ERR_GENERAL: See client logs. It might be CORS. Status text: "+o.statusText),t(new Error("ERR_GENERAL"))},o.open("POST",this.webOptions.accessTokenEndpoint,!0),o.setRequestHeader("accept","application/json"),this.webOptions.sendCacheControlHeader&&o.setRequestHeader("cache-control","no-cache"),o.setRequestHeader("content-type","application/x-www-form-urlencoded"),o.send(d.getTokenEndpointData(this.webOptions,i))}requestResource(e,r,t,i,o=null){if(this.webOptions.resourceUrl){const s=this.webOptions.logsEnabled;if(s&&this.doLog("Resource url: "+this.webOptions.resourceUrl),e){s&&this.doLog("Access token:",e);const n=this,l=new XMLHttpRequest;if(l.onload=function(){if(this.status===200){const a=JSON.parse(this.response);s&&n.doLog("Resource response:",a),a&&n.assignResponses(a,e,i,o),s&&n.doLog(n.MSG_RETURNED_TO_JS,a),r(a)}else t(new Error(this.statusText));n.closeWindow()},l.onerror=function(){s&&n.doLog("ERR_GENERAL: "+this.statusText),t(new Error("ERR_GENERAL")),n.closeWindow()},l.open("GET",this.webOptions.resourceUrl,!0),l.setRequestHeader("Authorization",`Bearer ${e}`),this.webOptions.additionalResourceHeaders)for(const a in this.webOptions.additionalResourceHeaders)l.setRequestHeader(a,this.webOptions.additionalResourceHeaders[a]);l.send()}else s&&this.doLog("No accessToken was provided although you configured a resourceUrl. Remove the resourceUrl from the config."),t(new Error("ERR_NO_ACCESS_TOKEN")),this.closeWindow()}else{const s={};this.assignResponses(s,e,i,o),this.webOptions.logsEnabled&&this.doLog(this.MSG_RETURNED_TO_JS,s),r(s),this.closeWindow()}}assignResponses(e,r,t,i=null){t&&(e.authorization_response=t),i&&(e.access_token_response=i),e.access_token=r}async logout(e){return new Promise((r,t)=>{localStorage.removeItem(d.getAppId(e)),r(!0)})}closeWindow(){var e;window.clearInterval(this.intervalId),(e=this.windowHandle)===null||e===void 0||e.close(),this.windowClosedByPlugin=!0}doLog(e,r=null){console.log("I/Capacitor/GenericOAuth2Plugin: "+e,r)}}export{R as GenericOAuth2Web};
