import{e as ae,j as e,P as S,B as s,w as xe,ap as Re,aq as Le,N as he,O as ue,U as Ne,aj as pe,_ as oe,a3 as Ce,au as Me,t as A,h as Q,i as X,r as d,T as n,y as De,H as F,as as He,M as Oe,L as B,am as Ge,W as Ke,K as ne,o as qe,l as D,av as Ue,A as J,aw as Fe,f as P,Q as te,a4 as _,aa as T,ax as $e,ay as Ze,az as Je,aA as je,V as Qe,al as Xe,ad as Ye,ae as en,aB as Se,aC as nn,aD as sn,x as tn,ai as rn,aE as an,aF as ln,n as on,aG as cn,R as ye,aH as dn,aI as hn,C as ve,aJ as un}from"./index-Do3xeu9r.js";import{C as xn,a as pn,M as gn,A as fn}from"./Modal-CKhmpr0V.js";import{T as mn,a as bn,b as _n,c as jn,d as we,e as U,f as yn}from"./TableRow-CNUBYHwX.js";import{S as vn}from"./sparkles-7xyn_Czm.js";import{G as v}from"./Grid-DRV51zze.js";import{searchCitiesByPostalCode as wn}from"./postalCodeLookup-Bx0v-AE9.js";import{P as kn}from"./plus-CX1I3BHy.js";import{R as Ae,a as re}from"./RadioGroup-Dx0Nc47M.js";import{U as zn}from"./user-check-CyOXMn5x.js";import{S as We}from"./shopping-cart-ZBH2cMIv.js";import{G as Cn}from"./gift-BUtoRtap.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sn=ae("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const An=ae("Hand",[["path",{d:"M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0",key:"aigmz7"}],["path",{d:"M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2",key:"1n6bmn"}],["path",{d:"M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8",key:"a9iiix"}],["path",{d:"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15",key:"1s1gnw"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=ae("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wn=ae("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=ae("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),ze=({currentSection:i,onSectionChange:l,collapsed:h,onToggleCollapse:g,isMobile:u=!1})=>{const f=[{id:"profile",label:"Persönliche Daten",icon:e.jsx(Ne,{size:20})},{id:"tokens",label:"Token-Guthaben",icon:e.jsx(pe,{size:20})},{id:"addresses",label:"Adressen",icon:e.jsx(oe,{size:20})},{id:"shipping",label:"Versand & Abholung",icon:e.jsx(Ce,{size:20})},{id:"display",label:"Anzeige",icon:e.jsx(Me,{size:20})},{id:"ai",label:"KI-Assistent",icon:e.jsx(vn,{size:20})},{id:"notifications",label:"Benachrichtigungen",icon:e.jsx(Sn,{size:20})}];return e.jsxs(S,{elevation:0,sx:{width:u?"100%":h?72:260,transition:"width 0.3s ease",height:u?"100%":"100vh",borderRight:u?0:1,borderColor:"divider",borderRadius:0,overflow:"auto",display:"flex",flexDirection:"column",position:u?"relative":"sticky",top:0,left:0},children:[!u&&e.jsx(s,{sx:{display:"flex",justifyContent:h?"center":"flex-end",p:1.5,borderBottom:1,borderColor:"divider"},children:e.jsx(xe,{onClick:g,size:"small",sx:{bgcolor:"action.hover","&:hover":{bgcolor:"action.selected"}},children:h?e.jsx(xn,{size:18}):e.jsx(pn,{size:18})})}),e.jsx(Re,{sx:{pt:2,pb:2},children:f.map(a=>{const W=e.jsxs(Le,{onClick:()=>l(a.id),selected:i===a.id,sx:{mb:.5,mx:h&&!u?1:1.5,borderRadius:2,minHeight:48,justifyContent:h&&!u?"center":"flex-start",px:h&&!u?0:2,"&.Mui-selected":{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},"& .MuiListItemIcon-root":{color:"white"}},"&:hover":{bgcolor:h&&!u?"action.hover":"action.selected"}},children:[e.jsx(he,{sx:{minWidth:h&&!u?"auto":40,justifyContent:"center",color:i===a.id?"inherit":"text.secondary"},children:a.icon}),(!h||u)&&e.jsx(ue,{primary:a.label,primaryTypographyProps:{fontWeight:i===a.id?600:400,fontSize:"0.95rem"}})]},a.id);return u?W:e.jsx(mn,{title:h?a.label:"",placement:"right",arrow:!0,children:W},a.id)})})]})},le=({fieldName:i,savedField:l,saveTimestamp:h,autoSaveStatus:g,showCheckmark:u,...f})=>e.jsx(A,{...f}),Tn=({profile:i,formData:l,onFormChange:h,userId:g,onProfileUpdate:u})=>{var fe,me;const f=Q(),a=X(f.breakpoints.down("md")),[W,j]=d.useState(!1),[b,w]=d.useState(!1),[p,z]=d.useState("idle"),[t,y]=d.useState(""),[V,I]=d.useState(null),[H,o]=d.useState(null),R=d.useRef(null),[se,L]=d.useState(!1),[N,$]=d.useState(null),r=x=>{$(x.currentTarget)},m=()=>{$(null)},C=()=>{var x;m(),(x=R.current)==null||x.click()},O=()=>{m(),L(!0)},c=x=>new Promise(k=>{const Z=new FileReader;Z.onload=be=>{var ie;const G=new Image;G.onload=()=>{const Y=document.createElement("canvas"),ee=Y.getContext("2d"),ce=1200,de=1200;let K=G.width,q=G.height;K>q?K>ce&&(q=q*ce/K,K=ce):q>de&&(K=K*de/q,q=de),Y.width=K,Y.height=q,ee==null||ee.drawImage(G,0,0,K,q),Y.toBlob(_e=>{if(_e){const Ve=new File([_e],x.name,{type:"image/jpeg",lastModified:Date.now()});k(Ve)}},"image/jpeg",.85)},G.src=(ie=be.target)==null?void 0:ie.result},Z.readAsDataURL(x)}),E=async x=>{if(!x.type.startsWith("image/")){alert("Bitte wähle eine Bilddatei aus");return}j(!0);try{const k=await c(x);if(k.size>5*1024*1024){alert("Die Datei ist zu groß. Maximal 5MB erlaubt."),j(!1);return}const Z=k.name.split(".").pop(),G=`avatars/${`${g}-${Date.now()}.${Z}`}`,{error:ie}=await P.storage.from("avatars").upload(G,k);if(ie)throw ie;const{data:{publicUrl:Y}}=P.storage.from("avatars").getPublicUrl(G),{error:ee}=await P.from("profiles").update({avatar_url:Y}).eq("id",g);if(ee)throw ee;u()}catch(k){console.error("Error uploading avatar:",k),alert("Fehler beim Hochladen des Bildes")}finally{j(!1)}},M=async x=>{var Z;const k=(Z=x.target.files)==null?void 0:Z[0];k&&await E(k)},ge=async x=>{await E(x)},Ie=async()=>{if(!l.phone||l.phone.trim()===""){I("Bitte gib zuerst eine Telefonnummer ein");return}w(!0),I(null);try{const{data:x,error:k}=await P.rpc("request_phone_verification",{p_phone:l.phone});if(k)throw k;x.success?(o(x.code),z("code-sent")):I(x.message)}catch(x){console.error("Verification request error:",x),I("Fehler beim Senden des Codes")}finally{w(!1)}},Be=async()=>{if(!t||t.length!==6){I("Bitte gib den 6-stelligen Code ein");return}w(!0),I(null);try{const{data:x,error:k}=await P.rpc("verify_phone_code",{p_code:t});if(k)throw k;x.success?(z("verified"),u()):I(x.message)}catch(x){console.error("Verification error:",x),I("Ungültiger oder abgelaufener Code")}finally{w(!1)}},Ee=a?s:S,Pe=a?{}:{sx:{p:3}};return e.jsxs(s,{children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1,display:{xs:"none",md:"block"}},children:"Persönliche Daten"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:{xs:2,md:4},display:{xs:"none",md:"block"}},children:"Verwalte deine persönlichen Informationen"}),e.jsxs(Ee,{...Pe,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",mb:4,flexDirection:{xs:"column",sm:"row"},textAlign:{xs:"center",sm:"left"}},children:[e.jsxs(s,{sx:{position:"relative",mb:{xs:2,sm:0}},children:[e.jsx(De,{src:(i==null?void 0:i.avatar_url)||void 0,sx:{width:100,height:100,fontSize:"2rem",bgcolor:"primary.main"},children:((me=(fe=l.full_name)==null?void 0:fe[0])==null?void 0:me.toUpperCase())||"U"}),e.jsx("input",{ref:R,type:"file",accept:"image/*",style:{display:"none"},onChange:M}),e.jsx(xe,{onClick:r,disabled:W,sx:{position:"absolute",bottom:0,right:0,bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},width:36,height:36},children:W?e.jsx(F,{size:18,color:"inherit"}):e.jsx(He,{size:18})}),e.jsxs(Oe,{anchorEl:N,open:!!N,onClose:m,transformOrigin:{horizontal:"right",vertical:"top"},anchorOrigin:{horizontal:"right",vertical:"bottom"},children:[e.jsxs(B,{onClick:O,children:[e.jsx(he,{children:e.jsx(Ge,{size:18})}),e.jsx(ue,{children:"Foto aufnehmen"})]}),e.jsxs(B,{onClick:C,children:[e.jsx(he,{children:e.jsx(Ke,{size:18})}),e.jsx(ue,{children:"Datei wählen"})]})]})]}),e.jsxs(s,{sx:{ml:{sm:3}},children:[e.jsx(n,{variant:"h6",fontWeight:600,children:l.full_name||"Kein Name"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:l.email})]})]}),e.jsxs(v,{container:!0,spacing:{xs:2,md:3},children:[e.jsx(v,{size:{xs:12,md:6},children:e.jsx(le,{fieldName:"full_name",fullWidth:!0,label:"Vollständiger Name",value:l.full_name,onChange:x=>h("full_name",x.target.value),helperText:"Dein voller Name wird anderen Nutzern angezeigt"})}),e.jsx(v,{size:{xs:12,md:6},children:e.jsx(A,{fullWidth:!0,label:"E-Mail-Adresse",value:l.email,disabled:!0,helperText:"Deine E-Mail-Adresse kann nicht geändert werden"})}),e.jsx(v,{size:{xs:12},children:e.jsxs(s,{children:[e.jsx(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:e.jsx(le,{fieldName:"phone",fullWidth:!0,label:"Telefonnummer",value:l.phone,onChange:x=>h("phone",x.target.value),placeholder:"+43 650 123456",disabled:(i==null?void 0:i.phone_verified)||p==="code-sent",InputProps:{endAdornment:i!=null&&i.phone_verified?e.jsx(ne,{icon:e.jsx(qe,{size:16}),label:"Verifiziert",color:"success",size:"small",sx:{mr:-1}}):void 0}})}),!(i!=null&&i.phone_verified)&&p==="idle"&&e.jsxs(s,{sx:{mt:2},children:[e.jsx(D,{variant:"outlined",startIcon:e.jsx(Ue,{size:18}),onClick:Ie,disabled:b||!l.phone,size:"small",children:b?"Sende Code...":"Telefonnummer verifizieren"}),e.jsx(n,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:"Erhöhe das Vertrauen durch Verifizierung deiner Telefonnummer"})]}),p==="code-sent"&&e.jsxs(s,{sx:{mt:2},children:[e.jsxs(J,{severity:"info",sx:{mb:2},children:[e.jsxs(n,{variant:"body2",sx:{mb:1},children:[e.jsx("strong",{children:"Demo-Modus:"})," Der Verifizierungscode lautet: ",e.jsx("strong",{children:H})]}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"In der Produktion würde dieser Code per SMS gesendet werden."})]}),e.jsxs(s,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(A,{label:"6-stelliger Code",value:t,onChange:x=>{const k=x.target.value.replace(/\D/g,"").slice(0,6);y(k)},placeholder:"123456",inputProps:{maxLength:6},sx:{width:"200px"},error:!!V,helperText:V}),e.jsx(D,{variant:"contained",onClick:Be,disabled:b||t.length!==6,children:b?"Prüfe...":"Verifizieren"}),e.jsx(D,{variant:"text",onClick:()=>{z("idle"),y(""),I(null)},children:"Abbrechen"})]})]}),p==="verified"&&e.jsx(J,{severity:"success",sx:{mt:2},children:"Deine Telefonnummer wurde erfolgreich verifiziert!"}),V&&p==="idle"&&e.jsx(J,{severity:"error",sx:{mt:2},children:V})]})}),e.jsx(v,{size:{xs:12,md:6},children:e.jsxs(le,{fieldName:"language",fullWidth:!0,select:!0,label:"Sprache",value:l.language,onChange:x=>h("language",x.target.value),helperText:"Bevorzugte Sprache für die App",SelectProps:{native:!0},children:[e.jsx("option",{value:"de",children:"Deutsch"}),e.jsx("option",{value:"en",children:"English"})]})}),e.jsx(v,{size:{xs:12},children:e.jsx(le,{fieldName:"bio",fullWidth:!0,label:"Über mich",value:l.bio,onChange:x=>h("bio",x.target.value),multiline:!0,rows:4,helperText:"Erzähle anderen Nutzern etwas über dich (optional)",placeholder:"Ich verkaufe gerne gebrauchte Artikel und bin immer auf der Suche nach guten Deals..."})})]})]}),e.jsx(Fe,{open:se,onClose:()=>L(!1),onCapture:ge})]})},In=({formData:i,onFormChange:l})=>{const h=Q(),g=X(h.breakpoints.down("md")),u=g?s:S,f=g?{}:{sx:{p:3}};return e.jsxs(s,{children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1,display:{xs:"none",md:"block"}},children:"KI-Assistent"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:4,display:{xs:"none",md:"block"}},children:"Passe an, wie die KI deine Inseratentexte erstellen soll"}),e.jsxs(u,{...f,children:[e.jsx(n,{variant:"h6",fontWeight:600,gutterBottom:!0,sx:{mb:2},children:"Textgenerierung"}),e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:2,mb:3},children:[e.jsxs(A,{fullWidth:!0,select:!0,label:"Schreibstil",value:i.ai_text_style,onChange:a=>l("ai_text_style",a.target.value),helperText:"Der Ton und die Art der generierten Texte",children:[e.jsx(B,{value:"formal",children:"Förmlich - Professionell und sachlich"}),e.jsx(B,{value:"casual",children:"Locker - Freundlich und ungezwungen"}),e.jsx(B,{value:"detailed",children:"Detailreich - Ausführlich und informativ"}),e.jsx(B,{value:"concise",children:"Prägnant - Kurz und auf den Punkt"}),e.jsx(B,{value:"balanced",children:"Ausgewogen - Gute Balance (empfohlen)"})]}),e.jsxs(A,{fullWidth:!0,select:!0,label:"Textlänge",value:i.ai_text_length,onChange:a=>l("ai_text_length",a.target.value),helperText:"Bevorzugte Länge der Beschreibungen",children:[e.jsx(B,{value:"short",children:"Kurz - Ca. 2-3 Sätze"}),e.jsx(B,{value:"medium",children:"Mittel - Ca. 4-6 Sätze (empfohlen)"}),e.jsx(B,{value:"long",children:"Lang - Ca. 7-10 Sätze"})]})]}),e.jsx(te,{sx:{my:3}}),e.jsx(n,{variant:"h6",fontWeight:600,gutterBottom:!0,sx:{mb:2},children:"Erweiterte Optionen"}),e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(_,{control:e.jsx(T,{checked:i.ai_include_emoji,onChange:a=>l("ai_include_emoji",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Emojis verwenden"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Die KI fügt passende Emojis in die Beschreibungen ein"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(s,{sx:{height:1,bgcolor:"divider",my:.5}}),e.jsx(_,{control:e.jsx(T,{checked:i.ai_allow_line_breaks,onChange:a=>l("ai_allow_line_breaks",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Zeilenumbrüche erlauben"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Die KI strukturiert Texte mit Absätzen für bessere Lesbarkeit"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(s,{sx:{height:1,bgcolor:"divider",my:.5}}),e.jsx(_,{control:e.jsx(T,{checked:i.ai_auto_publish,onChange:a=>l("ai_auto_publish",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Automatisch veröffentlichen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Inserate werden direkt nach der KI-Generierung veröffentlicht"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(s,{sx:{height:1,bgcolor:"divider",my:.5}}),e.jsx(_,{control:e.jsx(T,{checked:i.ai_analyze_all_images,onChange:a=>l("ai_analyze_all_images",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Alle Bilder analysieren"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Bei mehreren Bildern werden alle analysiert (teurer, aber detaillierter)"})]}),sx:{alignItems:"flex-start",m:0}})]})]})]})},Bn=({formData:i,onFormChange:l})=>{const h=Q(),g=X(h.breakpoints.down("md")),u=g?s:S,f=g?{}:{sx:{p:3}};return e.jsxs(s,{children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1,display:{xs:"none",md:"block"}},children:"Benachrichtigungen"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:4,display:{xs:"none",md:"block"}},children:"Wähle aus, wie du über Neuigkeiten informiert werden möchtest"}),e.jsx(u,{...f,children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(_,{control:e.jsx(T,{checked:i.notifications_enabled,onChange:a=>l("notifications_enabled",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Push-Benachrichtigungen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Erhalte Benachrichtigungen über neue Nachrichten und Aktivitäten"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(s,{sx:{height:1,bgcolor:"divider",my:.5}}),e.jsx(_,{control:e.jsx(T,{checked:i.email_notifications,onChange:a=>l("email_notifications",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"E-Mail-Benachrichtigungen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Erhalte wichtige Updates und Neuigkeiten per E-Mail"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(s,{sx:{height:1,bgcolor:"divider",my:.5}}),e.jsx(_,{control:e.jsx(T,{checked:i.newsletter_subscribed,onChange:a=>l("newsletter_subscribed",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Newsletter abonnieren"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Erhalte regelmäßig Angebote, Tipps und Neuigkeiten per E-Mail"})]}),sx:{alignItems:"flex-start",m:0}})]})})]})},En=({userId:i})=>{const l=Q(),h=X(l.breakpoints.down("md")),[g,u]=d.useState([]),[f,a]=d.useState(!0),[W,j]=d.useState(!1),[b,w]=d.useState(null),[p,z]=d.useState(!1),[t,y]=d.useState({name:"",address:"",postal_code:"",city:"",country:"AT",phone:"",show_phone_publicly:!1,is_default:!1,address_type:"both",is_default_shipping:!1}),[V,I]=d.useState([]),[H,o]=d.useState(!1);d.useEffect(()=>{const m=setTimeout(async()=>{if(t.postal_code.length>=4){o(!0);try{const O=(await wn(t.postal_code,t.country)).map(c=>c.city);console.log("AddressesSection: Found cities for",t.postal_code,t.country,":",O),I(O),O.length===1&&!t.city&&y(c=>({...c,city:O[0]}))}catch(C){console.error("Error fetching cities:",C)}finally{o(!1)}}else I([])},500);return()=>clearTimeout(m)},[t.postal_code,t.country]);const R=async()=>{a(!0);try{const{data:r,error:m}=await P.from("addresses").select("*").eq("user_id",i).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(m)throw m;u(r||[])}catch(r){console.error("Error loading addresses:",r)}finally{a(!1)}};d.useEffect(()=>{R()},[i]);const se=()=>{w(null),y({name:"",address:"",postal_code:"",city:"",country:"AT",phone:"",show_phone_publicly:!1,is_default:!1,address_type:"both",is_default_shipping:!1}),j(!0)},L=r=>{w(r),y({name:r.name||"",address:r.address,postal_code:r.postal_code,city:r.city,country:r.country,phone:r.phone||"",show_phone_publicly:r.show_phone_publicly||!1,is_default:r.is_default,address_type:r.address_type||"both",is_default_shipping:r.is_default_shipping||!1}),j(!0)},N=async()=>{var r,m;if(!(!t.address.trim()||!t.postal_code.trim()||!t.city.trim())){z(!0);try{if(b){const{error:C}=await P.from("addresses").update({name:t.name.trim()||"Meine Adresse",address:t.address.trim(),postal_code:t.postal_code.trim(),city:t.city.trim(),country:t.country,phone:((r=t.phone)==null?void 0:r.trim())||null,show_phone_publicly:t.show_phone_publicly,is_default:t.is_default,address_type:t.address_type,is_default_shipping:t.is_default_shipping}).eq("id",b.id);if(C)throw C}else{const{error:C}=await P.from("addresses").insert({user_id:i,name:t.name.trim()||"Meine Adresse",address:t.address.trim(),postal_code:t.postal_code.trim(),city:t.city.trim(),country:t.country,phone:((m=t.phone)==null?void 0:m.trim())||null,show_phone_publicly:t.show_phone_publicly,is_default:t.is_default,address_type:t.address_type,is_default_shipping:t.is_default_shipping});if(C)throw C}await R(),j(!1)}catch(C){console.error("Error saving address:",C)}finally{z(!1)}}},$=async r=>{if(window.confirm("Möchtest du diese Adresse wirklich löschen?"))try{const{error:m}=await P.from("addresses").delete().eq("id",r);if(m)throw m;await R()}catch(m){console.error("Error deleting address:",m)}};return f?e.jsx(s,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(F,{})}):e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(s,{sx:{display:{xs:"none",md:"block"}},children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1},children:"Adressen"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Verwalte deine Adressen für Abholung und Versand"})]}),e.jsx(D,{variant:"contained",startIcon:e.jsx(kn,{size:20}),onClick:se,sx:{ml:{xs:"auto",md:"auto"},mr:{xs:"auto",md:0}},children:g.length===0?"Adresse hinzufügen":h?"+ Adresse":"Neue Adresse"})]}),g.length===0?e.jsxs(S,{sx:{p:{xs:3,md:6},textAlign:"center"},children:[e.jsx(oe,{size:48,style:{margin:"0 auto 16px",color:"#999"}}),e.jsx(n,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"Keine Adressen vorhanden"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Füge deine erste Adresse über den Button oben hinzu"})]}):e.jsx(v,{container:!0,spacing:2,children:g.map(r=>{var m;return e.jsx(v,{size:{xs:12,md:6},children:e.jsx($e,{sx:{height:"100%",border:r.is_default?2:1,borderColor:r.is_default?"primary.main":"divider"},children:e.jsxs(Ze,{children:[e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Je,{size:20,color:r.is_default?"#1976d2":"#666"}),e.jsx(n,{variant:"h6",fontWeight:600,children:r.name||"Unbenannte Adresse"})]}),r.is_default&&e.jsx(n,{variant:"caption",sx:{bgcolor:"primary.main",color:"white",px:1.5,py:.5,borderRadius:1,fontWeight:600},children:"Standard"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:r.address}),e.jsxs(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:[r.postal_code," ",r.city]}),e.jsx(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:((m=je.find(C=>C.code===r.country))==null?void 0:m.name)||r.country}),r.phone&&e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Tel: ",r.phone]}),e.jsxs(s,{sx:{mt:2,display:"flex",gap:1,flexWrap:"wrap"},children:[(r.address_type==="both"||r.address_type==="pickup_only")&&e.jsx(s,{sx:{display:"flex",alignItems:"center",px:1.5,py:.75,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1.5,border:"1px solid",borderColor:"primary.main"},children:e.jsx(n,{variant:"caption",color:"primary.main",fontWeight:600,sx:{fontSize:"0.75rem",lineHeight:1},children:"Abholung"})}),(r.address_type==="both"||r.address_type==="shipping_only")&&e.jsx(s,{sx:{display:"flex",alignItems:"center",px:1.5,py:.75,bgcolor:"rgba(46, 125, 50, 0.08)",borderRadius:1.5,border:"1px solid",borderColor:"success.main"},children:e.jsx(n,{variant:"caption",color:"success.main",fontWeight:600,sx:{fontSize:"0.75rem",lineHeight:1},children:"Versand"})}),r.is_default_shipping&&e.jsx(s,{sx:{display:"flex",alignItems:"center",px:1.5,py:.75,bgcolor:"rgba(237, 108, 2, 0.08)",borderRadius:1.5,border:"1px solid",borderColor:"warning.main"},children:e.jsx(n,{variant:"caption",color:"warning.main",fontWeight:600,sx:{fontSize:"0.75rem",lineHeight:1},children:"Standard-Versand"})})]}),e.jsxs(s,{sx:{display:"flex",gap:1,mt:3},children:[e.jsx(D,{variant:"outlined",size:"medium",onClick:()=>L(r),fullWidth:!0,sx:{fontWeight:600,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:1.5}},children:"Bearbeiten"}),e.jsx(D,{variant:"outlined",color:"error",size:"medium",onClick:()=>$(r.id),sx:{minWidth:48,px:1.5,fontWeight:600,borderWidth:1.5,"&:hover":{borderWidth:1.5}},children:e.jsx(Qe,{size:18,strokeWidth:2})})]})]})})},r.id)})}),e.jsx(gn,{open:W,onClose:()=>j(!1),title:b?"Adresse bearbeiten":"Neue Adresse hinzufügen",maxWidth:"md",fullScreen:h,children:e.jsxs(v,{container:!0,spacing:3,children:[e.jsx(v,{size:{xs:12},children:e.jsx(A,{fullWidth:!0,label:"Name (optional)",value:t.name,onChange:r=>y({...t,name:r.target.value}),placeholder:"z.B. Zuhause, Arbeit"})}),e.jsx(v,{size:{xs:12},children:e.jsx(A,{fullWidth:!0,required:!0,label:"Straße und Hausnummer",value:t.address,onChange:r=>y({...t,address:r.target.value})})}),e.jsx(v,{size:{xs:12,sm:4},children:e.jsx(A,{fullWidth:!0,label:"PLZ",required:!0,value:t.postal_code,onChange:r=>y({...t,postal_code:r.target.value}),helperText:H?"Suche Orte...":V.length>0?`${V.length} Ort(e) gefunden`:""})}),e.jsx(v,{size:{xs:12,sm:8},children:e.jsx(Xe,{fullWidth:!0,freeSolo:!0,loading:H,options:V,value:t.city,onInputChange:(r,m)=>{y({...t,city:m||""})},renderInput:r=>e.jsx(A,{...r,label:"Ort",required:!0})})}),e.jsx(v,{size:{xs:12,sm:6},children:e.jsx(A,{fullWidth:!0,select:!0,label:"Land",value:t.country,onChange:r=>y({...t,country:r.target.value}),SelectProps:{native:!0},children:je.map(r=>e.jsx("option",{value:r.code,children:r.name},r.code))})}),e.jsx(v,{size:{xs:12,sm:6},children:e.jsx(A,{fullWidth:!0,label:"Telefon (optional)",value:t.phone,onChange:r=>y({...t,phone:r.target.value}),helperText:"Wird für Artikeldetails verwendet, falls freigegeben"})}),t.phone&&e.jsx(v,{size:{xs:12},children:e.jsx(_,{control:e.jsx(T,{checked:t.show_phone_publicly,onChange:r=>y({...t,show_phone_publicly:r.target.checked})}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",children:"Telefonnummer öffentlich anzeigen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Wenn aktiviert, wird deine Telefonnummer bei Artikeln mit dieser Adresse angezeigt"})]})})}),e.jsx(v,{size:{xs:12},children:e.jsxs(A,{fullWidth:!0,select:!0,label:"Adresstyp",value:t.address_type,onChange:r=>y({...t,address_type:r.target.value}),helperText:"Wähle aus, wofür diese Adresse verwendet werden soll",children:[e.jsx(B,{value:"both",children:"Abholung & Versand"}),e.jsx(B,{value:"pickup_only",children:"Nur Abholung"}),e.jsx(B,{value:"shipping_only",children:"Nur Versand"})]})}),e.jsx(v,{size:{xs:12},children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(_,{control:e.jsx(T,{checked:t.is_default,onChange:r=>y({...t,is_default:r.target.checked})}),label:"Als Standard-Adresse für Abholung festlegen"}),(t.address_type==="both"||t.address_type==="shipping_only")&&e.jsx(_,{control:e.jsx(T,{checked:t.is_default_shipping,onChange:r=>y({...t,is_default_shipping:r.target.checked})}),label:"Als Standard-Versandadresse festlegen"})]})}),e.jsx(v,{size:{xs:12},children:e.jsxs(s,{sx:{display:"flex",gap:2,justifyContent:"flex-end",pt:3,mt:2,borderTop:1,borderColor:"divider"},children:[e.jsx(D,{onClick:()=>j(!1),size:"large",sx:{minWidth:120},children:"ABBRECHEN"}),e.jsx(D,{variant:"contained",onClick:N,disabled:p||!t.address||!t.postal_code||!t.city,size:"large",sx:{minWidth:120},children:p?e.jsx(F,{size:24}):"SPEICHERN"})]})})]})})]})},Pn=({formData:i,onFormChange:l})=>{const h=Q(),g=X(h.breakpoints.down("md")),u=g?s:S,f=g?{}:{sx:{p:3,mb:3}};return e.jsxs(s,{children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1,display:{xs:"none",md:"block"}},children:"Versand & Abholung"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:4,display:{xs:"none",md:"block"}},children:"Lege fest, wie Käufer deine Artikel erhalten können"}),e.jsx(J,{severity:"info",sx:{mb:3},children:"Diese Einstellungen gelten als Standard für alle deine Artikel."}),e.jsxs(u,{...f,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:3},children:[e.jsx(Ce,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Versandoptionen"})]}),e.jsx(_,{control:e.jsx(T,{checked:i.shipping_enabled,onChange:a=>l("shipping_enabled",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Versand anbieten"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Biete Versand für deine Artikel an"})]}),sx:{alignItems:"flex-start",m:0,mb:3}}),i.shipping_enabled&&e.jsxs(s,{sx:{pl:{xs:0,sm:2},display:"flex",flexDirection:"column",gap:2.5},children:[e.jsxs(Ye,{component:"fieldset",children:[e.jsx(en,{component:"legend",sx:{mb:1.5,fontWeight:600,fontSize:"0.875rem"},children:"Versandkostenberechnung"}),e.jsxs(Ae,{value:i.shipping_cost_type,onChange:a=>l("shipping_cost_type",a.target.value),children:[e.jsx(_,{value:"free",control:e.jsx(re,{size:"small"}),label:"Kostenloser Versand",sx:{mb:1}}),e.jsx(_,{value:"fixed",control:e.jsx(re,{size:"small"}),label:"Feste Versandkosten",sx:{mb:1}}),e.jsx(_,{value:"ai_calculated",control:e.jsx(re,{size:"small"}),label:"KI-berechnet (automatisch)"})]})]}),i.shipping_cost_type==="fixed"&&e.jsx(A,{label:"Versandkosten",type:"number",size:"small",value:i.shipping_cost,onChange:a=>l("shipping_cost",parseFloat(a.target.value)||0),InputProps:{endAdornment:e.jsx(Se,{position:"end",children:"€"}),inputProps:{min:0,step:.5}},helperText:"Standard-Versandkosten pro Artikel",sx:{maxWidth:280}}),e.jsx(A,{fullWidth:!0,multiline:!0,rows:2,size:"small",label:"Versandbeschreibung (optional)",placeholder:"z.B. Versand mit DHL, Lieferzeit 2-3 Werktage",value:i.shipping_description||"",onChange:a=>l("shipping_description",a.target.value||null),helperText:"Zusätzliche Informationen zum Versand"})]})]}),e.jsxs(u,{...f,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:3},children:[e.jsx(oe,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Abholoptionen"})]}),e.jsx(_,{control:e.jsx(T,{checked:i.pickup_enabled,onChange:a=>l("pickup_enabled",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Abholung ermöglichen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Käufer können Artikel bei dir abholen"})]}),sx:{alignItems:"flex-start",m:0,mb:3}}),i.pickup_enabled&&e.jsxs(s,{sx:{pl:{xs:0,sm:2},display:"flex",flexDirection:"column",gap:2.5},children:[e.jsx(_,{control:e.jsx(T,{size:"small",checked:i.show_location_publicly,onChange:a=>l("show_location_publicly",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:500,children:"Standort öffentlich anzeigen"}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:i.show_location_publicly?"Vollständige Adresse wird angezeigt":"Nur PLZ und Ort sichtbar"})]}),sx:{alignItems:"flex-start",m:0}}),e.jsx(A,{fullWidth:!0,multiline:!0,rows:2,size:"small",label:"Abholbeschreibung (optional)",placeholder:"z.B. Abholung nach Vereinbarung, Parkplätze vorhanden",value:i.location_description||"",onChange:a=>l("location_description",a.target.value||null),helperText:"Zusätzliche Informationen zur Abholung"})]})]})]})},Vn=({formData:i,onFormChange:l})=>{const h=Q(),g=X(h.breakpoints.down("md")),u=g?s:S,f=g?{}:{sx:{p:3}};return e.jsxs(s,{children:[e.jsx(n,{variant:"h5",fontWeight:700,gutterBottom:!0,sx:{mb:1,display:{xs:"none",md:"block"}},children:"Anzeige-Einstellungen"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:4,display:{xs:"none",md:"block"}},children:"Passe die Darstellung der Anwendung an deine Bedürfnisse an"}),e.jsx(u,{...f,children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(nn,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Sprache"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Wähle die Sprache der Benutzeroberfläche"}),e.jsxs(A,{fullWidth:!0,select:!0,value:i.language,onChange:a=>l("language",a.target.value),SelectProps:{native:!0},children:[e.jsx("option",{value:"de",children:"Deutsch"}),e.jsx("option",{value:"en",children:"English"})]})]}),e.jsx(te,{sx:{my:2}}),e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(oe,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Standort-Sichtbarkeit"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Steuere, wer deinen Standort (Ort & Land) bei deinen Artikeln sehen kann"}),e.jsx(S,{elevation:0,sx:{p:2,border:1,borderColor:"divider",borderRadius:1,bgcolor:"grey.50"},children:e.jsx(_,{control:e.jsx(T,{checked:i.show_location_to_public,onChange:a=>l("show_location_to_public",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:500,children:"Standort für Besucher sichtbar"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:i.show_location_to_public?"Ort und Land sind für alle sichtbar (auch nicht angemeldete Besucher)":"Ort und Land sind nur für angemeldete Nutzer sichtbar"})]}),sx:{alignItems:"flex-start",m:0}})}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1.5,fontStyle:"italic"},children:"ℹ️ Vollständige Adressen sind nur für angemeldete Nutzer sichtbar, wenn du dies in den Abholoptionen aktiviert hast."})]}),e.jsx(te,{sx:{my:2}}),e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(An,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Händigkeit"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Optimiere die Button-Position für deine bevorzugte Hand bei der Ein-Hand-Bedienung"}),e.jsx(Ae,{value:i.hand_preference,onChange:a=>l("hand_preference",a.target.value),children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(S,{elevation:0,sx:{p:2,border:1,borderColor:i.hand_preference==="right"?"primary.main":"divider",borderRadius:1,cursor:"pointer","&:hover":{borderColor:"primary.main"}},onClick:()=>l("hand_preference","right"),children:e.jsx(_,{value:"right",control:e.jsx(re,{checked:i.hand_preference==="right"}),label:e.jsx(s,{sx:{display:"flex",alignItems:"center",gap:1.5},children:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Rechtshänder"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Navigation links, Aktionen rechts"})]})}),sx:{m:0,width:"100%"}})}),e.jsx(S,{elevation:0,sx:{p:2,border:1,borderColor:i.hand_preference==="left"?"primary.main":"divider",borderRadius:1,cursor:"pointer","&:hover":{borderColor:"primary.main"}},onClick:()=>l("hand_preference","left"),children:e.jsx(_,{value:"left",control:e.jsx(re,{checked:i.hand_preference==="left"}),label:e.jsx(s,{sx:{display:"flex",alignItems:"center",gap:1.5},children:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,children:"Linkshänder"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Navigation rechts, Aktionen links"})]})}),sx:{m:0,width:"100%"}})})]})})]}),e.jsx(te,{sx:{my:2}}),e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(zn,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Verkäuferprofil-Sichtbarkeit"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Zeige dein Profil in deinen Inseraten an, um Vertrauen aufzubauen"}),e.jsx(S,{elevation:0,sx:{p:2,border:1,borderColor:"divider",borderRadius:1,bgcolor:"grey.50"},children:e.jsx(_,{control:e.jsx(T,{checked:i.show_seller_profile,onChange:a=>l("show_seller_profile",a.target.checked)}),label:e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:500,children:"Verkäuferprofil in Inseraten anzeigen"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:i.show_seller_profile?"Dein Name, Avatar und andere Inserate werden in deinen Artikeln angezeigt":'Nur "Privater Verkäufer" wird angezeigt, keine persönlichen Infos'})]}),sx:{alignItems:"flex-start",m:0}})}),!i.show_seller_profile&&e.jsx(S,{elevation:0,sx:{p:2,mt:2,border:1,borderColor:"warning.main",borderRadius:1,bgcolor:"warning.50"},children:e.jsxs(s,{sx:{display:"flex",gap:1.5,alignItems:"flex-start"},children:[e.jsx(fn,{size:18,color:"#ed6c02",style:{flexShrink:0,marginTop:2}}),e.jsxs(s,{children:[e.jsx(n,{variant:"body2",fontWeight:600,color:"warning.dark",sx:{mb:.5},children:"Hinweis zur Sichtbarkeit"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Inserate mit sichtbarem Verkäuferprofil wirken seriöser und erhalten durchschnittlich 40% mehr Anfragen. Dein Name und Avatar helfen Interessenten, Vertrauen aufzubauen."})]})]})}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1.5,fontStyle:"italic"},children:"ℹ️ Du kannst dein Profilbild und deinen Namen jederzeit in den persönlichen Daten ändern."})]}),e.jsx(te,{sx:{my:2}}),e.jsxs(s,{children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(sn,{size:20,color:"#1976d2"}),e.jsx(n,{variant:"h6",fontWeight:600,children:"Standard-Schaltdauer"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Lege fest, wie lange deine Inserate standardmäßig online bleiben. Diese Dauer wird bei jedem neuen Inserat verwendet."}),e.jsx(A,{fullWidth:!0,type:"number",value:i.default_listing_duration,onChange:a=>{const W=parseInt(a.target.value);W>=10&&W<=30&&l("default_listing_duration",W)},inputProps:{min:10,max:30,step:1},helperText:"Zwischen 10 und 30 Tagen",InputProps:{endAdornment:e.jsx(Se,{position:"end",children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Tage"})})}}),e.jsx(S,{elevation:0,sx:{p:2,mt:2,border:1,borderColor:"divider",borderRadius:1,bgcolor:"grey.50"},children:e.jsx(n,{variant:"caption",color:"text.secondary",children:'📅 Deine Inserate werden nach Ablauf dieser Dauer automatisch als "abgelaufen" markiert und sind nicht mehr öffentlich sichtbar. Du kannst sie jederzeit wieder aktivieren.'})})]})]})})]})},Rn=i=>{const l=new Date(i);return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(l)},Ln=i=>({purchase:"Kauf",usage:"Verbrauch",bonus:"Bonus",refund:"Erstattung"})[i]||i,Nn=i=>({purchase:"success",usage:"error",bonus:"info",refund:"warning"})[i]||"info",Mn=i=>{switch(i){case"purchase":return e.jsx(We,{size:16});case"usage":return e.jsx(Te,{size:16});case"bonus":return e.jsx(Cn,{size:16});case"refund":return e.jsx(ln,{size:16});default:return e.jsx(pe,{size:16})}},Dn=()=>{const i=tn(),{balance:l,totalEarned:h,totalSpent:g,loading:u,fetchTransactions:f}=rn(),[a,W]=d.useState([]),[j,b]=d.useState(!1),w=async()=>{b(!0);try{const p=await f(50);W(p)}catch(p){console.error("Error loading transactions:",p)}finally{b(!1)}};return d.useEffect(()=>{w()},[]),e.jsxs(s,{children:[e.jsx(n,{variant:"h6",gutterBottom:!0,sx:{fontWeight:700,mb:3,display:{xs:"none",md:"block"}},children:"Token-Guthaben"}),e.jsxs(s,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(3, 1fr)"},gap:2,mb:4},children:[e.jsxs(S,{sx:{p:{xs:2,md:3},background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",color:"white",borderRadius:2},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(pe,{size:20}),e.jsx(n,{variant:"body2",sx:{opacity:.9},children:"Aktuelles Guthaben"})]}),e.jsx(n,{variant:"h3",sx:{fontWeight:700},children:u?e.jsx(F,{size:32,color:"inherit"}):l})]}),e.jsxs(S,{sx:{p:{xs:2,md:3},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(an,{size:20,color:"#4caf50"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Insgesamt erhalten"})]}),e.jsx(n,{variant:"h4",sx:{fontWeight:700,color:"success.main"},children:u?e.jsx(F,{size:28}):h})]}),e.jsxs(S,{sx:{p:{xs:2,md:3},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(Te,{size:20,color:"#f44336"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Insgesamt verbraucht"})]}),e.jsx(n,{variant:"h4",sx:{fontWeight:700,color:"error.main"},children:u?e.jsx(F,{size:28}):g})]})]}),e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(n,{variant:"h6",sx:{fontWeight:700},children:"Transaktionen"}),e.jsx(D,{variant:"contained",startIcon:e.jsx(We,{size:18}),onClick:()=>i("/tokens/buy"),sx:{textTransform:"none",fontWeight:600},children:"Tokens kaufen"})]}),j?e.jsx(s,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(F,{})}):a.length===0?e.jsx(J,{severity:"info",sx:{borderRadius:2},children:"Noch keine Transaktionen vorhanden."}):e.jsx(bn,{component:S,sx:{borderRadius:2},children:e.jsxs(_n,{children:[e.jsx(jn,{children:e.jsxs(we,{sx:{bgcolor:"rgba(0, 0, 0, 0.02)"},children:[e.jsx(U,{sx:{fontWeight:600},children:"Typ"}),e.jsx(U,{sx:{fontWeight:600},children:"Betrag"}),e.jsx(U,{sx:{fontWeight:600},children:"Gemini Tokens"}),e.jsx(U,{sx:{fontWeight:600},children:"Datum"})]})}),e.jsx(yn,{children:a.map(p=>{var z,t;return e.jsxs(we,{sx:{"&:hover":{bgcolor:"rgba(0, 0, 0, 0.02)"}},children:[e.jsx(U,{children:e.jsx(ne,{icon:Mn(p.transaction_type),label:Ln(p.transaction_type),color:Nn(p.transaction_type),size:"small",sx:{fontWeight:500}})}),e.jsx(U,{children:e.jsxs(n,{variant:"body2",sx:{fontWeight:600,color:p.amount>0?"success.main":"error.main"},children:[p.amount>0?"+":"",p.amount]})}),e.jsx(U,{children:p.gemini_total_tokens?e.jsxs(s,{children:[e.jsxs(n,{variant:"body2",sx:{fontWeight:500},children:[p.gemini_total_tokens.toLocaleString()," total"]}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[(z=p.gemini_input_tokens)==null?void 0:z.toLocaleString()," in / ",(t=p.gemini_output_tokens)==null?void 0:t.toLocaleString()," out"]})]}):e.jsx(n,{variant:"body2",color:"text.secondary",children:"-"})}),e.jsx(U,{children:e.jsx(n,{variant:"body2",color:"text.secondary",children:Rn(p.created_at)})})]},p.id)})})]})})]})},Hn=({userId:i,data:l,enabled:h,debounceMs:g=1e3})=>{const[u,f]=d.useState("idle"),[a,W]=d.useState(null),j=d.useRef(null),b=d.useRef(null),w=d.useRef(""),p=d.useRef(!0);return d.useEffect(()=>{if(!h||!i){console.log("⏸️ AutoSave disabled:",{enabled:h,userId:i});return}if(p.current){p.current=!1,w.current=JSON.stringify(l),console.log("🎬 AutoSave initialized");return}const z=JSON.stringify(l);if(z!==w.current)return console.log("📝 Data changed, scheduling save..."),w.current=z,j.current&&clearTimeout(j.current),f("idle"),j.current=setTimeout(async()=>{console.log("💾 Saving to database...",l),f("saving");try{const{error:t}=await P.from("profiles").update(l).eq("id",i);if(t)throw t;console.log("✅ Saved successfully!"),f("saved"),W(new Date),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{f("idle")},3e3)}catch(t){console.error("❌ Auto-save error:",t),f("error"),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{f("idle")},5e3)}},g),()=>{j.current&&clearTimeout(j.current),b.current&&clearTimeout(b.current)}},[i,l,h,g]),{status:u,lastSaved:a}},Yn=()=>{const{user:i}=on(),l=Q(),h=X(l.breakpoints.down("md")),[g]=cn(),[u,f]=d.useState(null),[a,W]=d.useState([]),[j,b]=d.useState(!0),[w,p]=d.useState(null),[z,t]=d.useState(g.get("section")||"profile"),[y,V]=d.useState(!1),[I,H]=d.useState(!1),[o,R]=d.useState({full_name:"",email:"",phone:"",bio:"",language:"de",notifications_enabled:!0,email_notifications:!0,newsletter_subscribed:!1,show_phone_publicly:!1,ai_text_style:"balanced",ai_text_length:"medium",ai_include_emoji:!1,ai_allow_line_breaks:!1,ai_auto_publish:!1,ai_analyze_all_images:!1,shipping_enabled:!1,shipping_cost:5,shipping_cost_type:"fixed",shipping_description:null,pickup_enabled:!0,show_location_publicly:!1,show_location_to_public:!0,location_description:null,default_listing_duration:30,hand_preference:"right",show_seller_profile:!0}),se=i?{full_name:o.full_name||null,phone:o.phone||null,bio:o.bio||null,language:o.language||null,notifications_enabled:o.notifications_enabled,email_notifications:o.email_notifications,newsletter_subscribed:o.newsletter_subscribed,show_phone_publicly:o.show_phone_publicly,ai_text_style:o.ai_text_style,ai_text_length:o.ai_text_length,ai_include_emoji:o.ai_include_emoji,ai_auto_publish:o.ai_auto_publish,ai_allow_line_breaks:o.ai_allow_line_breaks,ai_analyze_all_images:o.ai_analyze_all_images,shipping_enabled:o.shipping_enabled,shipping_cost:o.shipping_cost,shipping_cost_type:o.shipping_cost_type,shipping_description:o.shipping_description,pickup_enabled:o.pickup_enabled,show_location_publicly:o.show_location_publicly,location_description:o.location_description,default_listing_duration:o.default_listing_duration,show_location_to_public:o.show_location_to_public,hand_preference:o.hand_preference,show_seller_profile:o.show_seller_profile}:{},{status:L,lastSaved:N}=Hn({userId:(i==null?void 0:i.id)||"",data:se,enabled:!!i,debounceMs:1e3}),$=async()=>{if(i){b(!0);try{const{data:c,error:E}=await P.from("profiles").select("*").eq("id",i.id).maybeSingle();if(E)throw E;if(c){f(c);const M={full_name:c.full_name||"",email:c.email||"",phone:c.phone||"",bio:c.bio||"",language:c.language||"de",notifications_enabled:c.notifications_enabled??!0,email_notifications:c.email_notifications??!0,newsletter_subscribed:c.newsletter_subscribed??!1,show_phone_publicly:c.show_phone_publicly??!1,ai_text_style:c.ai_text_style||"balanced",ai_text_length:c.ai_text_length||"medium",ai_include_emoji:c.ai_include_emoji??!1,ai_allow_line_breaks:c.ai_allow_line_breaks??!1,ai_auto_publish:c.ai_auto_publish??!1,ai_analyze_all_images:c.ai_analyze_all_images??!1,shipping_enabled:c.shipping_enabled??!1,shipping_cost:c.shipping_cost??0,shipping_cost_type:c.shipping_cost_type||"fixed",shipping_description:c.shipping_description||null,pickup_enabled:c.pickup_enabled??!0,show_location_publicly:c.show_location_publicly??!1,show_location_to_public:c.show_location_to_public??!0,location_description:c.location_description||null,default_listing_duration:c.default_listing_duration??30,hand_preference:c.hand_preference||"right",show_seller_profile:c.show_seller_profile??!0};R(M)}}catch(c){console.error("Error loading profile:",c),p("Fehler beim Laden des Profils")}finally{b(!1)}}},r=(c,E)=>{R(M=>({...M,[c]:E}))},m=c=>{const E=Math.floor((new Date().getTime()-c.getTime())/1e3);if(E<10)return"gerade eben";if(E<60)return`vor ${E}s`;const M=Math.floor(E/60);return M<60?`vor ${M}min`:`vor ${Math.floor(M/60)}h`};if(d.useEffect(()=>{$()},[i]),d.useEffect(()=>{const c=g.get("section");c&&["overview","profile","addresses","shipping","display","ai","notifications","tokens"].includes(c)&&t(c)},[g]),j)return e.jsx(ye,{maxWidth:"xl",sx:{py:4},children:e.jsx(s,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(F,{size:60})})});const C=()=>{switch(z){case"profile":return e.jsx(Tn,{profile:u,formData:{full_name:o.full_name,email:o.email,phone:o.phone,bio:o.bio,language:o.language},onFormChange:r,userId:(i==null?void 0:i.id)||"",onProfileUpdate:$});case"addresses":return i?e.jsx(En,{userId:i.id}):null;case"shipping":return e.jsx(Pn,{formData:{shipping_enabled:o.shipping_enabled,shipping_cost:o.shipping_cost,shipping_cost_type:o.shipping_cost_type,shipping_description:o.shipping_description,pickup_enabled:o.pickup_enabled,show_location_publicly:o.show_location_publicly,location_description:o.location_description,show_ai_shipping_costs:!1},onFormChange:r});case"display":return e.jsx(Vn,{formData:{language:o.language,show_location_to_public:o.show_location_to_public,default_listing_duration:o.default_listing_duration,hand_preference:o.hand_preference,show_seller_profile:o.show_seller_profile},onFormChange:r});case"ai":return e.jsx(In,{formData:{ai_text_style:o.ai_text_style,ai_text_length:o.ai_text_length,ai_include_emoji:o.ai_include_emoji,ai_auto_publish:o.ai_auto_publish,ai_allow_line_breaks:o.ai_allow_line_breaks,ai_analyze_all_images:o.ai_analyze_all_images},onFormChange:r});case"tokens":return e.jsx(Dn,{});case"notifications":return e.jsx(Bn,{formData:{notifications_enabled:o.notifications_enabled,email_notifications:o.email_notifications,newsletter_subscribed:o.newsletter_subscribed},onFormChange:r});default:return null}},O=()=>({overview:"Übersicht",profile:"Persönliche Daten",addresses:"Adressen",shipping:"Versand & Abholung",display:"Anzeige",ai:"KI-Assistent",notifications:"Benachrichtigungen"})[z];return h?e.jsxs(s,{children:[e.jsx(dn,{position:"sticky",elevation:1,sx:{bgcolor:"background.paper",color:"text.primary"},children:e.jsxs(hn,{children:[e.jsx(xe,{edge:"start",onClick:()=>H(!0),sx:{mr:2},children:e.jsx(Wn,{size:24})}),e.jsx(n,{variant:"h6",fontWeight:600,children:O()}),e.jsxs(s,{sx:{ml:"auto"},children:[L==="saving"&&e.jsx(ne,{icon:e.jsx(ke,{size:14,style:{animation:"spin 1s linear infinite"}}),label:"Speichert...",size:"small",sx:{height:28}}),L==="saved"&&N&&e.jsx(ne,{icon:e.jsx(ve,{size:14}),label:`Gespeichert ${m(N)}`,size:"small",color:"success",sx:{height:28}})]})]})}),e.jsx(un,{anchor:"left",open:I,onClose:()=>H(!1),sx:{"& .MuiDrawer-paper":{width:280}},children:e.jsx(ze,{currentSection:z,onSectionChange:c=>{t(c),H(!1)},collapsed:!1,onToggleCollapse:()=>{},isMobile:!0})}),e.jsxs(s,{sx:{py:2,px:2},children:[w&&e.jsx(J,{severity:"error",sx:{mb:2},onClose:()=>p(null),children:w}),C()]})]}):e.jsxs(s,{sx:{display:"flex",minHeight:"calc(100vh - 200px)"},children:[e.jsx(ze,{currentSection:z,onSectionChange:t,collapsed:y,onToggleCollapse:()=>V(!y)}),e.jsxs(s,{sx:{flex:1,pl:4,pr:4,py:4,position:"relative"},children:[e.jsxs(s,{sx:{position:"fixed",top:80,right:24,zIndex:1e3},children:[L==="saving"&&e.jsx(ne,{icon:e.jsx(ke,{size:14,style:{animation:"spin 1s linear infinite"}}),label:"Speichert...",size:"small",sx:{height:28}}),L==="saved"&&N&&e.jsx(ne,{icon:e.jsx(ve,{size:14}),label:`Gespeichert ${m(N)}`,size:"small",color:"success",sx:{height:28}})]}),e.jsxs(ye,{maxWidth:"lg",disableGutters:!0,children:[w&&e.jsx(J,{severity:"error",sx:{mb:3},onClose:()=>p(null),children:w}),C()]})]})]})};export{Yn as SettingsPage};
